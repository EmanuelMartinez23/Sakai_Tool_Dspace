<!-- start: chef_assignments_instructor_new_edit_assignment.vm  -->
#set( $H = '-' )
#set( $T = 'T' )
#rubricsRequirements
<!-- Initialize the Bootstrap-multiselect plugin: -->
<script>
    $(document).ready(function() {
        $('#selectedGroups').multiselect({
            selectAllText: '$tlang.getString("asn.edit.selectall")',
            nonSelectedText: '$tlang.getString("asn.edit.selectone")',
            allSelectedText: '$tlang.getString("asn.edit.allselected")',
            nSelectedText: ' $tlang.getString("asn.edit.groupsselected")',
            filterPlaceholder: '$tlang.getString("asn.edit.searchgroup")',
            enableFiltering: true,
            enableCaseInsensitiveFiltering: true,
            includeSelectAllOption: true,
            templates: {
                button: `
                    <button type="button"
                            class="btn btn-primary multiselect dropdown-toggle"
                            data-bs-toggle="dropdown">
                        <span class="multiselect-selected-text"></span>
                        <i class="si si-caret-down-fill ps-2"></i>
                    </button>
                `,
                filter: `
                    <div class="multiselect-filter d-flex align-items-center"><i class="fa fa-sm fa-search text-muted"></i><input type="search" class="multiselect-search form-control" /></div>
                `,
            },
        });
        $('#selectedGroups').change(function(){
            ASN_INE.validateGroupSelection();
        });
    });
</script>
<script>
	#if($turnitin_forceSingleAttachment)
		function forceSingleAttachment(checked) {
			if(checked){
 				$("#subType").val(5);
 			}
			$("#subType > option").each(function(){
 				    if(checked){
					if($(this).val() != 5){
 						$(this).prop('disabled', 'disabled');
					}
 					}else{
						$(this).removeProp('disabled');
		 			}
 			});
		}
        #end
	$(document).ready(function() {
		ASN.setupAssignNew();
		#if($turnitin_forceSingleAttachment)
		   	if ($("#new_assignment_use_review_service").is(':checked')) {
				forceSingleAttachment(true);
			} 
		 	$("#new_assignment_use_review_service").click(function (){
		 		var checked = this.checked;
				forceSingleAttachment(checked);
		 	});
		#end
		ASN_INE.validateGroupSelection();
	});

	## handles the Student Submissions dropdown
	function switchAssignmentSubmissionType()
	{
		var useReview = document.getElementById('$name_UseReviewService');
		var lblUseReview=document.getElementById('lblReviewService');
		var reviewSwitchNe1 = document.getElementById('review.switch.ne.1');
		var reviewSwitchNe2 = document.getElementById('review.switch.ne.2');
		if(document.getElementById('subType').value == 6)
        {
			document.getElementById('External_Tool_Fieldset').style.display = 'block';
			document.getElementById('ltiSubmissionResubmitNote').style.display = 'block';
			document.getElementById('assignToSection').style.display = 'none';
			document.getElementById('site').checked = true;
			document.getElementById('notificationOptions').style.display = 'none';
			document.getElementById('notsendnotif').checked = true;
			document.getElementById('releaseGradeNotifications').style.display = 'none';
			document.getElementById('notsendreleasegradenotif').checked = true;
			document.getElementById('additionalInformation').style.display = 'none';
			document.getElementById('peerAssessmentCheckboxLabel').checked = false;
			document.getElementById('peerAssessmentContainer').style.display = 'none';
        } else {
			document.getElementById('External_Tool_Fieldset').style.display = 'none';
			document.getElementById('ltiSubmissionResubmitNote').style.display = 'none';
			document.getElementById('assignToSection').style.display = 'block';
			document.getElementById('notificationOptions').style.display = 'block';
			document.getElementById('releaseGradeNotifications').style.display = 'block';
			document.getElementById('additionalInformation').style.display = 'block';
			document.getElementById('peerAssessmentContainer').style.display = 'block';
        }

		if(document.getElementById('subType').value != 4 )
		{
			#if ($allowReviewService)
				reviewSwitchNe1.style.display='none';
				lblReviewService.className='';
				reviewSwitchNe2.style.display='none';
				useReview.disabled=false;
				lblUseReview.style.display = 'block';
			#end
			document.getElementById('tempAllowRes').parentNode.parentNode.style.display = 'block';
			if (document.getElementById('allowResToggle').checked)
			{
				document.getElementById('allowResubmitNumber').style.display = 'block';
				document.getElementById('allowResubmitTime').style.display = 'block';
				document.getElementById('resubmitNotification').style.display = 'block';
				ASN.resizeFrame();
			}
		}
		else
		{
			#if ($allowReviewService)
				if (useReview.checked)
				{
					reviewSwitchNe2.style.removeProperty('display');
					ASN.toggleReviewServiceOptions(this.checked);
				}
				useReview.checked=false;
				useReview.disabled=true;
				lblUseReview.className='';
				reviewSwitchNe1.style.removeProperty('display');
				lblUseReview.style.display = 'none';
			#end
			document.getElementById('tempAllowRes').parentNode.parentNode.style.display = 'none';
			document.getElementById('allowResToggle').checked = false;
			document.getElementById('allowResubmitNumber').style.display = 'none';
			document.getElementById('allowResubmitTime').style.display = 'none';
			document.getElementById('resubmitNotification').style.display = 'none';
		}
	}
	focus_path = [ '$fField' ];
</script>

<style>
    /* DSpace Section Styles */
    .dspace-section {
        border: 1px solid #8c8a8a;
    }

    .dspace-container {
        padding: 1rem;
    }

    .dspace-community {
        margin-bottom: 1rem;
        border: 1px solid #ccc;
        border-radius: 4px;
        background: white;
        overflow: hidden;
    }

    .dspace-community-header {
        background: #2c5aa0;
        color: white;
        padding: 0.75rem 1rem;
        font-weight: bold;
        display: flex;
        align-items: center;
        cursor: pointer;
        transition: background-color 0.3s ease;
        user-select: none;
    }

    .dspace-community-header:hover {
        background: #1e3d6f;
    }

    .dspace-community-header .icon {
        margin-right: 0.5rem;
    }

    .dspace-community-header .chevron {
        margin-right: 0.5rem;
        transition: transform 0.3s ease;
        font-size: 0.8em;
    }

    .dspace-collections {
        padding: 0;
        background: #f8f9fa;
    }

    .dspace-collection {
        margin: 0;
        border-bottom: 1px solid #e0e0e0;
    }

    .dspace-collection:last-child {
        border-bottom: none;
    }

    .dspace-collection-header {
        background: #6c757d;
        color: white;
        padding: 0.6rem 1rem 0.6rem 2rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        cursor: pointer;
        transition: background-color 0.3s ease;
        user-select: none;
    }

    .dspace-collection-header:hover {
        background: #5a6268;
    }

    .dspace-collection-header .icon {
        margin-right: 0.5rem;
        font-size: 0.9em;
    }

    .dspace-collection-header .chevron {
        margin-right: 0.5rem;
        transition: transform 0.3s ease;
        font-size: 0.7em;
    }

    .dspace-items-table-container {
        max-height: 300px;
        overflow-y: auto;
        margin: 0;
        border: none;
        border-radius: 0;
        background: white;
    }

    .dspace-items-table {
        margin: 0;
        font-size: 0.875rem;
        border: 1px solid #dee2e6;
        width: 100%;
    }

    .dspace-items-table th {
        background: #343a40 !important;
        color: white !important;
        position: sticky;
        top: 0;
        z-index: 10;
        font-weight: 600;
        border: 1px solid #454d55;
        padding: 0.75rem;
        text-align: left;
    }

    .dspace-items-table td {
        vertical-align: middle;
        padding: 0.75rem;
        border: 1px solid #dee2e6;
        color: white;
    }

    .table-row-even {
        background-color: #495057 !important;
    }

    .table-row-even:hover {
        background-color: #5a6268 !important;
    }

    .table-row-odd {
        background-color: #6c757d !important;
    }

    .table-row-odd:hover {
        background-color: #7a8288 !important;
    }

    .bitstream-link {
        color: #80bdff !important;
        text-decoration: none;
        font-size: 0.8em;
        margin-left: 0.5rem;
        font-weight: 500;
    }

    .bitstream-link:hover {
        text-decoration: underline;
        color: #a6d2ff !important;
    }

    /* Vertical stacking for bitstream Add buttons */
    .add-url-actions .bitstream-buttons {
        display: flex;
        flex-direction: column;
        gap: 6px;
        align-items: flex-start;
    }
    .add-url-actions .bitstream-buttons .btn {
        display: inline-block;
        width: auto;
    }

    .collapsible.active .chevron {
        transform: rotate(90deg);
    }

    .collapsible-content {
        transition: all 0.3s ease;
    }

    .dspace-items-table-container::-webkit-scrollbar {
        width: 8px;
    }

    .dspace-items-table-container::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    .dspace-items-table-container::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
    }

    .dspace-items-table-container::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }

    @media (max-width: 768px) {
        .dspace-items-table-container {
            max-height: 200px;
        }

        .dspace-items-table {
            font-size: 0.8rem;
        }

        .dspace-items-table th,
        .dspace-items-table td {
            padding: 0.5rem;
        }

        .dspace-community-header,
        .dspace-collection-header {
            padding: 0.6rem 0.75rem;
        }

        .dspace-collection-header {
            padding-left: 1.5rem;
        }
    }

    .collapsible-content {
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        function toggleCollapse(element) {
            const content = element.nextElementSibling;
            const isActive = element.classList.contains('active');

            if (isActive) {
                element.classList.remove('active');
                content.style.display = 'none';
            } else {
                element.classList.add('active');
                content.style.display = 'block';
            }
        }

        // Exclude DSpace-specific headers to avoid double-binding
        const collapsibleHeaders = document.querySelectorAll('.collapsible:not(.dspace-community-header):not(.dspace-collection-header)');
        collapsibleHeaders.forEach(header => {
            header.addEventListener('click', function() {
                toggleCollapse(this);
            });
        });

    });
</script>

#javascript("/library/js/lang-datepicker/lang-datepicker.js")
## Include other javascript specific to this page
#javascript("/sakai-assignment-tool/js/instructorNewEdit.js")

<script type="text/javascript">
  // Abre una ventana de previsualización EPUB sin document.write y carga epub.js de forma segura
  function openEpubPreview() {
    try {
      var w = window.open('about:blank', 'epubPreviewWindow', 'width=1024,height=768,menubar=no,toolbar=no,location=no,status=no');
      if (!w) {
        alert('Por favor, permita las ventanas emergentes para ver la previsualización.');
        return;
      }

      var source = 'http://192.168.1.27:4000/bitstreams/332d156e-2621-4665-ab21-a4ddf6ba63fa/download';
      // Construir URL del action del tool (AssignmentAction) usando eventSubmit_doEpub_proxy
      var u = new URL(window.location.href);
      var sp = u.searchParams;
      sp.set('eventSubmit_doEpub_proxy', '1');
      sp.set('url', source);
      u.search = sp.toString();
      var proxyUrl = u.toString();

      var d = w.document;
      // Título y elementos base
      d.title = 'Previsualizador EPUB';
      var head = d.head || d.getElementsByTagName('head')[0] || d.createElement('head');
      if (!d.head) d.documentElement.insertBefore(head, d.body || null);

      // Estilos
      var style = d.createElement('style');
      style.type = 'text/css';
      style.appendChild(d.createTextNode(
        '*{box-sizing:border-box}\n' +
        'html,body{height:100%}\n' +
        'body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#f6f6f6;color:#222;display:flex;flex-direction:column}\n' +
        'header{background:#0f6cbf;color:#fff;padding:10px 14px;display:flex;align-items:center;gap:10px}\n' +
        '#controls{margin-left:auto;display:flex;gap:6px}\n' +
        'button{background:#fff;color:#222;border:1px solid #d0d0d0;border-radius:6px;padding:6px 10px;cursor:pointer}\n' +
        'button:hover{background:#f0f0f0}\n' +
        '#status{font-size:12px;opacity:.9;margin-left:8px}\n' +
        'main{flex:1;display:flex;min-height:0}\n' +
        '#viewer{flex:1;background:#fff;margin:10px;border:1px solid #e0e0e0;border-radius:8px;overflow:hidden;display:flex}\n' +
        '#log{font-size:12px;color:#555;padding:6px 10px}'
      ));
      head.appendChild(style);

      // Estructura del cuerpo
      var body = d.body || d.createElement('body');
      if (!d.body) d.documentElement.appendChild(body);

      var header = d.createElement('header');
      var h1 = d.createElement('h1'); h1.textContent = 'Previsualizador EPUB'; header.appendChild(h1);
      var status = d.createElement('div'); status.id = 'status'; header.appendChild(status);
      var controls = d.createElement('div'); controls.id = 'controls';
      var prevBtn = d.createElement('button'); prevBtn.id = 'prevBtn'; prevBtn.title = 'Página anterior'; prevBtn.appendChild(d.createTextNode('\u2B05')); // ⬅
      var nextBtn = d.createElement('button'); nextBtn.id = 'nextBtn'; nextBtn.title = 'Página siguiente'; nextBtn.appendChild(d.createTextNode('\u27A1')); // ➡
      var demoBtn = d.createElement('button'); demoBtn.id = 'demoBtn'; demoBtn.title = 'Cargar EPUB de prueba'; demoBtn.textContent = 'Demo';
      controls.appendChild(prevBtn); controls.appendChild(nextBtn); controls.appendChild(demoBtn); header.appendChild(controls);

      var main = d.createElement('main');
      var viewer = d.createElement('div'); viewer.id = 'viewer';
      var log = d.createElement('div'); log.id = 'log'; log.setAttribute('aria-live','polite');

      body.appendChild(header); body.appendChild(main); main.appendChild(viewer); body.appendChild(log);

      function setStatus(msg){ status.textContent = msg || ''; }
      function logMsg(){ try { var m = Array.prototype.slice.call(arguments).join(' '); (w.console&&w.console.log)&&w.console.log('[EPUB]', m); log.textContent = m; } catch(e){} }
      w.onerror = function(m,s,l,c,e){ logMsg('Error global:', m, '@', s+':'+l); setStatus('Error'); };

      // Inicialización del visor una vez cargado epub.js
      function initViewer(){
        setStatus('Descargando…');
        var respHeaders = {};
        w.fetch(proxyUrl, { credentials: 'same-origin' })
          .then(function(res){
            respHeaders.type = res.headers.get('content-type');
            respHeaders.length = res.headers.get('content-length');
            respHeaders.disposition = res.headers.get('content-disposition');
            respHeaders.proxyHit = res.headers.get('x-epub-proxy');
            respHeaders.status = res.status;
            respHeaders.statusText = res.statusText;
            respHeaders.finalUrl = res.url;
            // No arrojamos error aquí; leemos siempre el cuerpo para poder mostrar diagnóstico completo
            return res.arrayBuffer().then(function(buf){ return { buf: buf, ok: res.ok }; });
          })
          .then(function(result){
            var buf = result.buf;
            var ok = result.ok;
            // Intentar extraer nombre de archivo (Content-Disposition o URL)
            function deriveFilename(){
              var cd = respHeaders.disposition || '';
              var m = cd.match(/filename\*=UTF-8''([^;\s]+)/i);
              if (m && m[1]) { try { return decodeURIComponent(m[1]); } catch(e) { return m[1]; } }
              m = cd.match(/filename="?([^";]+)"?/i);
              if (m && m[1]) return m[1];
              try {
                var u = new URL(respHeaders.finalUrl || proxyUrl);
                var last = u.pathname.split('/').filter(Boolean).pop();
                if (last) return last;
              } catch(e) {}
              try {
                var su = new URL(source);
                var slast = su.pathname.split('/').filter(Boolean).pop();
                if (slast) return slast;
              } catch(e) {}
              return 'archivo.epub';
            }
            var filename = deriveFilename();

            // Validar cabecera ZIP ("PK\x03\x04")
            var bytes = new Uint8Array(buf);
            var isZip = bytes.length >= 4 && bytes[0] === 0x50 && bytes[1] === 0x4B; // 'P''K'

            if (!ok || !isZip) {
              setStatus('Error');
              var snippet = '';
              try { snippet = new TextDecoder('utf-8').decode(bytes.slice(0, 200)); } catch(e) {}
              var details = 'Archivo origen (DSpace): ' + source + '\n' +
                'Descargando desde (proxy): ' + proxyUrl + '\n' +
                'URL final de respuesta: ' + (respHeaders.finalUrl || '(desconocida)') + '\n' +
                'HTTP: ' + (respHeaders.status || '?') + ' ' + (respHeaders.statusText || '') + '\n' +
                'X-EPUB-PROXY: ' + (respHeaders.proxyHit || '(sin cabecera)') + '\n' +
                'Content-Type: ' + (respHeaders.type || 'desconocido') + '\n' +
                'Content-Length: ' + (respHeaders.length || 'desconocido') + '\n' +
                'Content-Disposition: ' + (respHeaders.disposition || '—') + '\n' +
                'Nombre de archivo estimado: ' + filename + '\n' +
                'Primeros bytes: ' + Array.prototype.slice.call(bytes,0,8).map(function(b){return b.toString(16).padStart(2,'0');}).join(' ') + '\n' +
                (snippet ? ('Snippet:\n' + snippet) : '');
              (w.console&&w.console.error)&&w.console.error('[EPUB] No se pudo abrir/descargar como EPUB', details);
              viewer.innerHTML = '<div style="padding:20px;color:#a00;white-space:pre-wrap;"><strong>No se pudo descargar/abrir el EPUB.</strong>\n\n' + details.replace(/</g,'&lt;') + '</div>';
              var links = d.createElement('div');
              links.style.padding = '10px 20px';
              var a1 = d.createElement('a'); a1.href = proxyUrl; a1.target = '_blank'; a1.rel = 'noopener'; a1.textContent = 'Abrir respuesta del proxy';
              var sep = d.createTextNode(' \u00A0 ');
              var a2 = d.createElement('a'); a2.href = source; a2.target = '_blank'; a2.rel = 'noopener'; a2.textContent = 'Abrir URL de origen (DSpace)';
              links.appendChild(a1); links.appendChild(sep); links.appendChild(a2);
              viewer.appendChild(links);
              return; // abortar
            }

            setStatus('Abriendo…');
            try {
              // Abrir directamente el ArrayBuffer como binario para evitar peticiones a /META-INF/container.xml
              var book = w.ePub();
              book.open(buf, 'binary');
              var rendition = book.renderTo('viewer', { width: '100%', height: '100%' });
              rendition.display();
              prevBtn.addEventListener('click', function(){ rendition.prev(); });
              nextBtn.addEventListener('click', function(){ rendition.next(); });
              w.addEventListener('keydown', function(e){ if (e.key === 'ArrowLeft') rendition.prev(); if (e.key === 'ArrowRight') rendition.next(); });
              book.ready.then(function(){ return book.locations.generate(1600); }).then(function(){
                rendition.on('relocated', function(loc){
                  try {
                    var current = book.locations.percentageFromCfi(loc.start.cfi);
                    var pct = Math.max(0, Math.min(100, Math.round((current || 0) * 100)));
                    setStatus(pct + '%');
                  } catch (e) { setStatus(''); }
                });
              }).catch(function(err){ (w.console&&w.console.error)&&w.console.error('Error generando locations', err); });
              if (book && book.loaded && book.loaded.metadata) { book.loaded.metadata.then(function(meta){ if (meta && meta.title) d.title = meta.title + ' — Previsualizador EPUB'; }).catch(function(){}); }
            } catch (err) {
              (w.console&&w.console.error)&&w.console.error('No se pudo inicializar el visor EPUB:', err);
              viewer.innerHTML = '<div style="padding:20px;color:#a00;">No se pudo inicializar el previsualizador EPUB.</div>';
              setStatus('Error');
            }
          })
          .catch(function(err){
            // Este catch captura fallos de red/JS antes de leer el cuerpo
            (w.console&&w.console.error)&&w.console.error('Fallo al descargar el EPUB desde el proxy', err);
            setStatus('Error');
            var html = '<div style="padding:20px;white-space:pre-wrap;">' +
              'No se pudo descargar el EPUB desde el servidor.\n' +
              'Archivo origen (DSpace): ' + source + '\n' +
              'Descargando desde (proxy): ' + proxyUrl + '</div>';
            viewer.innerHTML = html;
            var linkWrap = d.createElement('div'); linkWrap.style.padding = '10px 20px';
            var a = d.createElement('a'); a.href = proxyUrl; a.target = '_blank'; a.rel = 'noopener'; a.textContent = 'Descargar archivo';
            linkWrap.appendChild(a);
            viewer.appendChild(linkWrap);
          });
      }

      // Cargar epub.js y JSZip dinámicamente en la ventana hija (intenta primero webjars locales)
      var remaining = 2;
      function onLibLoaded(){ remaining--; if (remaining === 0) initViewer(); }
      function injectScript(src, onload, onerror){ var s=d.createElement('script'); s.src=src; s.onload=onload; s.onerror=onerror; head.appendChild(s); }
      // JSZip: intentar varias rutas locales de webjars, luego CDN
      function loadJSZipLocalThenCdn(done){
        var tried = [];
        var candidates = [
          '/library/webjars/jszip/3.10.1/dist/jszip.min.js',
          '/library/webjars/jszip/3.10.1/jszip.min.js'
        ];
        function tryNext(){
          var src = candidates.shift();
          if (!src) {
            (w.console&&w.console.warn)&&w.console.warn('No se pudo cargar JSZip desde /library/webjars, probando CDN');
            injectScript('https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js', done, function(){
              (w.console&&w.console.error)&&w.console.error('No se pudo cargar JSZip desde CDN');
              done();
            });
            return;
          }
          injectScript(src, done, function(){
            tried.push(src);
            tryNext();
          });
        }
        tryNext();
      }
      loadJSZipLocalThenCdn(onLibLoaded);
      // epub.js desde CDN (si tienes ruta local, la cambio a local en siguiente iteración)
      injectScript('https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js', onLibLoaded, function(){
        setStatus('Error'); log.textContent = 'No se pudo cargar epub.js';
      });

      // Botón Demo: construye un EPUB mínimo en memoria y lo abre
      demoBtn.addEventListener('click', function(){
        if (!w.JSZip) { log.textContent = 'JSZip no está disponible'; return; }
        setStatus('Generando demo…');
        try {
          var zip = new w.JSZip();
          // EPUB exige que el archivo "mimetype" sea el primero y sin compresión
          zip.file('mimetype', 'application/epub+zip', { compression: 'STORE' });
          zip.file('META-INF/container.xml', (
            '<?xml version="1.0"?>\n' +
            '<container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container">\n' +
            '  <rootfiles>\n' +
            '    <rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"/>\n' +
            '  </rootfiles>\n' +
            '</container>\n'
          ));
          zip.file('OEBPS/title.xhtml', (
            '<?xml version="1.0" encoding="utf-8"?>\n' +
            '<!DOCTYPE html>\n' +
            '<html xmlns="http://www.w3.org/1999/xhtml">\n' +
            '<head><title>Demo EPUB</title><meta charset="utf-8"/></head>\n' +
            '<body><h1>EPUB de prueba</h1><p>Este es un EPUB mínimo generado en memoria para probar el visor.</p></body>\n' +
            '</html>\n'
          ));
          zip.file('OEBPS/content.opf', (
            '<?xml version="1.0" encoding="utf-8"?>\n' +
            '<package xmlns="http://www.idpf.org/2007/opf" unique-identifier="BookId" version="2.0">\n' +
            '  <metadata xmlns:dc="http://purl.org/dc/elements/1.1/">\n' +
            '    <dc:title>Demo EPUB</dc:title>\n' +
            '    <dc:language>es</dc:language>\n' +
            '    <dc:identifier id="BookId">urn:uuid:demo-epub</dc:identifier>\n' +
            '  </metadata>\n' +
            '  <manifest>\n' +
            '    <item id="title" href="title.xhtml" media-type="application/xhtml+xml"/>\n' +
            '  </manifest>\n' +
            '  <spine toc="ncx">\n' +
            '    <itemref idref="title"/>\n' +
            '  </spine>\n' +
            '</package>\n'
          ));
          zip.generateAsync({ type: 'arraybuffer' }).then(function(buf){
            setStatus('Abriendo demo…');
            try {
              var book = w.ePub();
              book.open(buf, 'binary');
              var rendition = book.renderTo('viewer', { width: '100%', height: '100%' });
              rendition.display();
            } catch(e) {
              setStatus('Error');
              (w.console&&w.console.error)&&w.console.error('Error abriendo demo EPUB', e);
              log.textContent = 'Error abriendo demo EPUB';
            }
          });
        } catch (e) {
          setStatus('Error');
          (w.console&&w.console.error)&&w.console.error('Error generando demo EPUB', e);
          log.textContent = 'Error generando demo EPUB';
        }
      });

      w.focus();
    } catch (e) {
      if (window.console && console.error) console.error('Error abriendo previsualizador EPUB:', e);
    }
  }
</script>

<div class="portletBody container-fluid">
 #navBarOnClick( $allowAddAssignment $allowGradeSubmission $allowAddAssignment $allowRecoverAssignment $allowAllGroups $assignmentscheck $allowUpdateSite $enableViewOption $view "newAssignmentForm" "new" )

    <!-- Botón de previsualización EPUB (temporal, en blanco) -->
    <div class="d-flex justify-content-end mb-3">
      <button type="button" id="btnEpubPreview" class="btn btn-outline-secondary" onclick="openEpubPreview()">
        <span class="me-1" aria-hidden="true"><i class="si si-eye"></i></span>
        Previsualizar EPUB
      </button>
    </div>

	<div class="page-header">
		<h1>
		#if($formattedText.escapeHtml($!value_title) && $formattedText.escapeHtml($!value_title) !='')
			$formattedText.escapeHtml($!value_title) <span class="highlight">	$tlang.getString("edit")</span>
		#else
			$tlang.getString("new.title")
		#end
		</h1>
	</div>

	## Mostrar alerta en rojo solo si NO hay mensaje de éxito simultáneo
	#if ($alertMessage && !$successMessage)
		<div class="sak-banner-error" id="generalAlert">
			<strong>$tlang.getString("gen.alert")</strong> $alertMessage
		</div>
	#end

	## Success/info message (STATE_MESSAGE) should be green/blue, not red
	#if ($successMessage)
		<div class="sak-banner-success" id="generalSuccess">
			$formattedText.escapeHtml($successMessage)
		</div>
	#end

	#set($submitnotif="submitnotifTop")

	<form name="newAssignmentForm" id="newAssignmentForm" action="#toolForm("AssignmentAction")" method="post" onsubmit="return true;">
		<input type="hidden" name="assignmentId" value="$!assignmentId" />
		<input type="hidden" name="eventSubmit_doAssignment_form" value="" />
		<input type="hidden" name="option" id="option" value="" />
		<input type="hidden" name="view" id="view" value="" />
		<input type="hidden" name="$name_order" id="$name_order" value="$!value_position_order" />

		<div class="form-group row form-required">
			<label for="$name_title" class="col-sm-12 form-control-label block">
				$tlang.getString("gen.title")
			</label>
			<div class="col-sm-8">
				<input name="$name_title" id="$name_title" type="text" value="$formattedText.escapeHtml($!value_title)" maxlength="100" class="form-control" placeholder="$tlang.getString("gen.title")" />
			</div>
		</div>

		<div class="longtext form-group row form-required">
			<label for="$name_Description" class="block form-control-label col-sm-12">
				$tlang.getString("gen.assinf")
			</label>
			<div class="col-sm-12">
                        #set($contextkey = "ckeditor-autosave-context")
                        #set($entitykey = "ckeditor-autosave-entity-id")
                        #set($entityval = "$assignmentId")
                        <input type="hidden" id="$contextkey" name="$contextkey" value="asn_instructor_edit">
                        <input type="hidden" id="$entitykey" name="$entitykey" value="$entityval">

				<table border="0" style="margin:0"><tr><td>
					<textarea name="$name_Description" id="$name_Description" cols="80" rows="30" wrap="virtual">$formattedText.escapeHtmlFormattedTextarea($value_Description)</textarea>
					#chef_setupformattedtextarea($name_Description)
					</td></tr>
				</table>
			</div>
		</div>

		<div class="checkbox">
			<label for="$name_CheckAddHonorPledge">
				<input id="$name_CheckAddHonorPledge" name="$name_CheckAddHonorPledge" type="checkbox" value="true"
					#if ($!value_CheckAddHonorPledge)
                       checked="checked"
					#end
				/>
				$tlang.getString("gen.addhonple")
			</label>
		</div>

		## attachments
		<h4>
			$tlang.getString("gen.att")
		</h4>
		#set ($size = 0)
		#set ($props = false)
		#foreach ($attachment in $attachments)
			#set ($props = $attachment.Properties)
			#if ($!props)
				#set ($size = $size + 1)
			#end
		#end
		#if ($size == 0)
			<p class="text-info">
                            #if ($value_SubmissionType == 5)
                                $tlang.getString("gen.noatt.single")
                            #else
                                $tlang.getString("gen.noatt")
                            #end
                        </p>

			<div class="act">
				<input type="button" name="attach" value="$tlang.getString('gen.addatt')" onclick="document.getElementById('option').value='attach';document.newAssignmentForm.submit();return false;"/>
			</div>
		#else
			<ul class="attachList indnt1">
				#foreach ($attachment in $attachments)
					<input type="hidden" name="attachments" id="attachments" value="$attachment.Reference" />
					#set ($props = false)
					#set ($props = $attachment.Properties)
					#if ($!props)
						<li>
							#if ($props.getBooleanProperty($props.NamePropIsCollection))
								<img src = "#imageLink($contentTypeImageService.getContentTypeImage("folder"))" border="0" alt="$tlang.getString("gen.folatt")" />
							#else
								<img src = "#imageLink($contentTypeImageService.getContentTypeImage($props.getProperty($props.NamePropContentType)))" border="0" alt="$tlang.getString("gen.filatt")" />
							#end
							<a href="$attachment.Url" target="_blank">$formattedText.escapeHtml($props.getPropertyFormatted($props.NamePropDisplayName))</a>
							#propertyDetails($props)
						</li>
					#end
				#end
			</ul>
			<div class="act">
				<input type="button" name="attach" value="$tlang.getString('gen.adddroatt')" onclick="document.getElementById('option').value='attach';document.newAssignmentForm.submit();return false;" />
			</div>
		#end

        <h4>Repositorio Institucional (Colecciones)</h4>
        <div class="dspace-section">
            <div class="dspace-container">
                #if($dspaceError)
                    <div class="alert alert-warning">$!dspaceError</div>
                #end

                #if($dspaceTree && $dspaceTree.size() > 0)
                    <!-- Show Comunidades-->
                    #foreach($comm in $dspaceTree)
                        <div class="dspace-community">
                            <div class="dspace-community-header collapsible">
                                <i class="fa fa-chevron-right chevron"></i>
                                <i class="fa fa-users icon"></i>
                                <span class="community-name">$!comm.name</span>
                            </div>
                            <div class="dspace-collections collapsible-content" style="display: none;">
                                #set($collections = $!comm.collections)
                                #if($collections && $collections.size() > 0)
                                    <!-- Show Colecciones -->
                                    #foreach($col in $collections)
                                        <div class="dspace-collection">
                                            <div class="dspace-collection-header collapsible">
                                                <i class="fa fa-chevron-right chevron"></i>
                                                <i class="fa fa-folder icon"></i>
                                                <span class="collection-name">$!col.name</span>
                                            </div>
                                            <div class="dspace-items-table-container collapsible-content" style="display: none;">
                                                #set($items = $!col.items)
                                                #if($items && $items.size() > 0)
                                                    <table class="dspace-items-table table table-bordered table-sm">
                                                        <thead>
                                                            <tr>
                                                                <th>Item</th>
                                                                <th>Bitstreams</th>
                                                                <th>Previsualizar EPUB</th>
                                                                <th>Agregar como URL</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            #set($rowClass = "table-row-even")
                                                        <!-- Show Items-->
                                                            #foreach($it in $items)
                                                                <tr class="$rowClass">
                                                                    <td>$!it.title</td>
                                                                    <td>
                                                                        #set($bss = $!it.bitstreams)
                                                                        #if($bss && $bss.size() > 0)
                                                                            <div class="bitstream-list">
                                                                                #foreach($b in $bss)
                                                                                    <div class="bitstream-item">
                                                                                        <input type="checkbox" name="selectedBitstreams" id="$!b.uuid" value="$!b.uuid" />
                                                                                        <label for="$!b.uuid" class="file-name">$!b.name</label>
                                                                                        #if($b.downloadUrl)
                                                                                            <a href="$!b.downloadUrl" download="$!b.name" target="_blank" class="bitstream-link">[Link]</a>
                                                                                        #end
                                                                                    </div>
                                                                                #end
                                                                            </div>
                                                                        #else
                                                                            <span class="text-muted">No hay bitstreams</span>
                                                                        #end
                                                                    </td>
                                                                    <td>
                                                                        #if($bss && $bss.size() > 0)
                                                                            <div class="bitstream-buttons">
                                                                                #foreach($b in $bss)
                                                                                    #set($name = "$!b.name")
                                                                                    #if($name && $name.toLowerCase().endsWith('.epub') && $b.uuid)
                                                                                        <a class="btn btn-primary btn-sm preview-epub" href="#" data-uuid="$!b.uuid" title="Previsualizar $!b.name" target="_blank">EPUB</a>
                                                                                    #else
                                                                                        <span class="text-muted">Sin vista previa</span>
                                                                                    #end
                                                                                #end
                                                                            </div>
                                                                        #else
                                                                            <span class="text-muted">Sin bitstreams</span>
                                                                        #end
                                                                    </td>
                                                                    <td>
                                                                        <div class="add-url-actions">
                                                                            #if($bss && $bss.size() > 0)
                                                                                <div class="bitstream-buttons">
                                                                                    #foreach($b in $bss)
                                                                                        #if($b.downloadUrl)
                                                                                            <button type="button" class="btn btn-light btn-sm text-dark add-as-url" data-name="$!b.name" data-url="$!b.downloadUrl" title="Agregar bitstream $!b.name">Agregar</button>
                                                                                        #else
                                                                                            <button type="button" class="btn btn-light btn-sm text-dark add-as-url" data-name="$!b.name" title="Agregar bitstream $!b.name">Agregar</button>
                                                                                        #end
                                                                                    #end
                                                                                </div>
                                                                            #else
                                                                                <span class="text-muted">Sin bitstreams</span>
                                                                            #end
                                                                        </div>
                                                                    </td>
                                                                </tr>
                                                                #set($rowIndex = $rowIndex + 1)
                                                            #end
                                                        </tbody>
                                                    </table>
                                                #else
                                                    <p class="text-muted" style="padding: 0.75rem;">No hay items en esta colección.</p>
                                                #end
                                            </div>
                                        </div>
                                    #end
                                #else
                                    <p class="text-muted" style="padding: 0.75rem;">No hay colecciones en esta comunidad.</p>
                                #end
                            </div>
                        </div>
                    #end
                #else
                    <p class="text-muted">No hay datos de DSpace para mostrar.</p>
                #end
            <div class="mt-2">
            <button type="button" class="btn btn-success" onclick="document.getElementById('option').value='download_dspace_bitstreams';document.newAssignmentForm.submit();return false;">
                Descargar los archivos seleccionados
            </button>
        </div>
        </div>

        <script>
            (function(){

                // Paginación simple sin dependencias externas (solo requiere jQuery ya presente en Sakai)
                function initSimplePagination(context, options){
                    var jq = window.jQuery; if (!jq) return;
                    var cfg = jq.extend({ pageLength: 5 }, options || {});
                    var jqCtx = context ? jq(context) : jq(document);
                    jqCtx.find('table.dspace-items-table').each(function(){
                        var jTable = jq(this);
                        if (jTable.data('simplePagerInit')) return;
                        var jTbody = jTable.find('tbody');
                        var jRows = jTbody.children('tr');
                        var total = jRows.length;
                        var pageLen = cfg.pageLength;
                        // Si no hay suficientes filas, no renderizamos controles y mostramos todo
                        if (total <= pageLen) {
                            jTable.data('simplePagerInit', true);
                            return;
                        }
                        var totalPages = Math.ceil(total / pageLen);
                        var state = { page: 1, totalPages: totalPages, pageLength: pageLen, totalRows: total };
                        // Crear contenedor de paginación
                        var jPager = jq('<div class="dspace-simple-pager mt-2 d-flex align-items-center gap-1"></div>');

                        var jBtnPrev  = jq('<button type="button" class="mx-2 btn btn-light btn-sm text-dark" aria-label="Anterior">&lsaquo;</button>');
                        var jInfo     = jq('<span class="mx-2 small text-muted text-dark"></span>');
                        var jBtnNext  = jq('<button type="button" class="mx-2 btn btn-light btn-sm text-dark " aria-label="Siguiente">&rsaquo;</button>');

                        jPager.append( jBtnPrev, jInfo, jBtnNext);
                        jTable.after(jPager);
                        function render(){
                            var start = (state.page - 1) * state.pageLength;
                            var end = start + state.pageLength;
                            jRows.hide().slice(start, end).show();
                            jInfo.text('Página ' + state.page + ' de ' + state.totalPages);
                            jBtnPrev.prop('disabled', state.page === 1);
                            jBtnNext.prop('disabled', state.page === state.totalPages);
                        }
                        jBtnPrev.on('click', function(){ if (state.page > 1) { state.page--; render(); }});
                        jBtnNext.on('click', function(){ if (state.page < state.totalPages) { state.page++; render(); }});
                        // Guardar estado y renderizar
                        jTable.data('simplePagerInit', true).data('simplePagerState', state);
                        render();
                    });
                }
                // Carga DataTables dinámicamente si no está presente
                function ensureDataTablesAvailable(callback){
                    function available(){ return window.jQuery && jQuery.fn && (jQuery.fn.dataTable || jQuery.fn.DataTable); }
                    if (available()) { callback(); return; }
                    if (!window.jQuery) {
                        if (window.console && console.error) console.error('[DSpaceTables] jQuery no está cargado. DataTables requiere jQuery.');
                        return;
                    }
                    // Asegurar CSS
                    if (!document.getElementById('dt-autoload-css')) {
                        var link = document.createElement('link');
                        link.id = 'dt-autoload-css';
                        link.rel = 'stylesheet';
                        // Primero intentamos el CSS del webjar de datatables + bootstrap5
                        link.href = '/library/webjars/datatables/1.10.25/css/dataTables.bootstrap5.min.css';
                        link.onerror = function(){
                            // Fallback a CSS básico del CDN si el webjar no existe
                            link.href = 'https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css';
                        };
                        document.head.appendChild(link);
                    }
                    // Asegurar JS
                    var existing = document.getElementById('dt-autoload-js');
                    if (!existing) {
                        var s = document.createElement('script');
                        s.id = 'dt-autoload-js';
                        // Orden de intentos: webjar → /library/js → /js → CDN
                        var webjar = '/library/webjars/datatables/1.10.25/js/jquery.dataTables.min.js';
                        var primary = '/library/js/jquery.dataTables.min.js';
                        var fallback1 = '/js/jquery.dataTables.min.js';
                        var fallback2 = 'https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js';
                        s.src = webjar;
                        s.async = true;
                        s.onload = function(){ if (window.console && console.debug) console.debug('[DSpaceTables] DataTables cargado dinámicamente.'); };
                        s.onerror = function(){
                            if (window.console && console.warn) console.warn('[DSpaceTables] Error cargando ' + webjar + ', probando ' + primary);
                            s.onerror = function(){
                                if (window.console && console.warn) console.warn('[DSpaceTables] Error cargando ' + primary + ', probando ' + fallback1);
                                s.onerror = function(){
                                    if (window.console && console.warn) console.warn('[DSpaceTables] Error cargando ' + fallback1 + ', probando CDN ' + fallback2);
                                    s.onerror = function(){ if (window.console && console.error) console.error('[DSpaceTables] Error cargando ' + fallback2); };
                                    s.src = fallback2;
                                };
                                s.src = fallback1;
                            };
                            s.src = primary;
                        };
                        document.head.appendChild(s);
                    }
                    var tries = 0;
                    (function waitReady(){
                        if (available()) { callback(); return; }
                        if (++tries > 40) { if (window.console && console.error) console.error('[DSpaceTables] DataTables no estuvo disponible tras la carga.'); return; }
                        setTimeout(waitReady, 250);
                    })();
                }
                function initDspaceTables(context){
                    var attempts = 0;
                    function tryInit(){
                        attempts++;
                        if (!window.jQuery || !jQuery.fn || (!jQuery.fn.dataTable && !jQuery.fn.DataTable)) {
                            if (attempts < 20) {
                                if (window.console && console.debug) console.debug('[DSpaceTables] DataTables no disponible aún. Reintento #' + attempts);
                                setTimeout(tryInit, 250);
                            } else {
                                if (window.console && console.error) console.error('[DSpaceTables] DataTables no se cargó. Verifica que jquery.dataTables esté incluido en esta página.');
                            }
                            return;
                        }
                        if (window.console && console.debug) console.debug('[DSpaceTables] DataTables disponible. Inicializando en contexto:', context || document);
                        var jqCtx = context ? jQuery(context) : jQuery(document);
                        jqCtx.find('table.dspace-items-table').each(function(){
                            var dtTable = jQuery(this);
                            if (jQuery.fn.dataTable.isDataTable(this)) return;
                            try {
                                dtTable.DataTable({
                                    dom: 'ftp',
                                    paging: true,
                                    pagingType: 'simple_numbers',
                                    searching: true,
                                    ordering: true,
                                    info: true,
                                    lengthChange: false,
                                    pageLength: 4,
                                    language: {
                                        paginate: {
                                            next: '$!tlang.getString("datatables.custom.next")',
                                            previous: '$!tlang.getString("datatables.custom.previous")'
                                        },
                                        emptyTable: '$!tlang.getString("datatables.emptyTable")',
                                        zeroRecords: '$!tlang.getString("datatables.zeroRecords")'
                                    },
                                    drawCallback: function() {
                                        // Aplicar estilos a la paginación
                                        $(this).closest('.dataTables_wrapper').find('.dataTables_paginate .paginate_button')
                                                .css({
                                                    'color': 'black',
                                                    'margin': '0 2px'
                                                });

                                        // Aplicar estilos al buscador
                                        $(this).closest('.dataTables_wrapper').find('.dataTables_filter label')
                                                .css('color', 'black');

                                        // Aplicar estilos al input del buscador
                                        $(this).closest('.dataTables_wrapper').find('.dataTables_filter input')
                                                .css({
                                                    'background-color': '#f0f0f0', // Gris claro
                                                    'color': 'black',
                                                    'border': '1px solid #ccc',
                                                    'padding': '4px 8px'
                                                });
                                    }
                                });
                            } catch (e) {
                                // Swallow to avoid breaking the page if DT is not fully ready
                            }
                        });
                    }
                    tryInit();
                }
                function toggleNextContent(header){
                    var next = header.nextElementSibling;
                    if (!next) return;
                    var isHidden = next.style.display === 'none' || next.style.display === '';
                    next.style.display = isHidden ? 'block' : 'none';
                    header.classList.toggle('active', isHidden);
                    header.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
                    next.setAttribute('aria-hidden', isHidden ? 'false' : 'true');
                    if (isHidden) {
                        initSimplePagination(next);
                    }
                }
                function bindDspaceToggles(){
                    document.querySelectorAll('.dspace-community-header.collapsible').forEach(function(el){
                        if (el.__dspaceBound) return; el.__dspaceBound = true;
                        el.setAttribute('role', 'button');
                        el.setAttribute('tabindex', '0');
                        el.setAttribute('aria-expanded', 'false');
                        el.addEventListener('click', function(){ toggleNextContent(el); });
                        el.addEventListener('keydown', function(e){ if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleNextContent(el); }});
                    });
                    document.querySelectorAll('.dspace-collection-header.collapsible').forEach(function(el){
                        if (el.__dspaceBound) return; el.__dspaceBound = true;
                        el.setAttribute('role', 'button');
                        el.setAttribute('tabindex', '0');
                        el.setAttribute('aria-expanded', 'false');
                        el.addEventListener('click', function(){ toggleNextContent(el); });
                        el.addEventListener('keydown', function(e){ if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleNextContent(el); }});
                    });
                    ensureDataTablesAvailable(function(){ initDspaceTables(document); });
                }
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', bindDspaceToggles);
                } else {
                    bindDspaceToggles();
                }
            })();
        </script>

        <script>
            (function(){
                var EDITOR_ID = '$name_Description';
                function notify(message, type){
                    try {
                        var id = 'dspace-add-url-toast';
                        var el = document.getElementById(id);
                        if (!el){
                            el = document.createElement('div');
                            el.id = id;
                            el.style.position = 'fixed';
                            el.style.top = '10px';
                            el.style.right = '10px';
                            el.style.zIndex = '9999';
                            el.style.maxWidth = '360px';
                            document.body.appendChild(el);
                        }
                        var box = document.createElement('div');
                        box.className = (type === 'warn' ? 'sak-banner-warn' : 'sak-banner-info');
                        box.style.marginBottom = '8px';
                        box.style.padding = '8px 12px';
                        box.style.borderRadius = '4px';
                        box.style.boxShadow = '0 2px 6px rgba(0,0,0,0.2)';
                        // Evitar icono de fondo de los banners de Sakai y controlar el layout
                        box.style.backgroundImage = 'none';
                        box.style.display = 'flex';
                        box.style.alignItems = 'center';
                        box.style.gap = '8px';
                        var icon = document.createElement('i');
                        icon.className = type === 'warn' ? 'fa fa-exclamation-triangle' : 'fa fa-info-circle';
                        icon.setAttribute('aria-hidden', 'true');
                        var text = document.createElement('span');
                        text.textContent = message;
                        box.appendChild(icon);
                        box.appendChild(text);
                        el.appendChild(box);
                        setTimeout(function(){
                            try { el.removeChild(box); } catch(e){}
                        }, 3500);
                    } catch(e) { /* no-op */ }
                }
                function sanitizeFilename(name){
                    return (name||'recurso').replace(/[^A-Za-z0-9-_\.]+/g, '_');
                }
                function triggerDownload(url, filename){
                    if (!url) return;
                    try {
                        var a = document.createElement('a');
                        a.href = url;
                        if (filename) a.setAttribute('download', sanitizeFilename(filename));
                        a.style.display = 'none';
                        document.body.appendChild(a);
                        a.click();
                        setTimeout(function(){ try { document.body.removeChild(a); } catch(e){} }, 100);
                    } catch(e) { /* ignore */ }
                }
                function getEditorHtml(){
                    try {
                        if (window.CKEDITOR && CKEDITOR.instances && CKEDITOR.instances[EDITOR_ID]) {
                            return CKEDITOR.instances[EDITOR_ID].getData() || '';
                        }
                    } catch(e) {}
                    try {
                        if (window.tinymce) {
                            var ed = tinymce.get(EDITOR_ID) || tinymce.get(String(EDITOR_ID));
                            if (ed) return ed.getContent() || '';
                        }
                    } catch(e) {}
                    var ta = document.getElementById(EDITOR_ID);
                    return ta ? ta.value : '';
                }
                function setEditorHtml(html){
                    try {
                        if (window.CKEDITOR && CKEDITOR.instances && CKEDITOR.instances[EDITOR_ID]) {
                            CKEDITOR.instances[EDITOR_ID].setData(html);
                            return;
                        }
                    } catch(e) {}
                    try {
                        if (window.tinymce) {
                            var ed = tinymce.get(EDITOR_ID) || tinymce.get(String(EDITOR_ID));
                            if (ed) { ed.setContent(html); return; }
                        }
                    } catch(e) {}
                    var ta = document.getElementById(EDITOR_ID);
                    if (ta) ta.value = html;
                }
                function htmlToDiv(html){ var d=document.createElement('div'); d.innerHTML = html || ''; return d; }
                function findOrCreateResourcesBlock(root){
                    // Try to find existing heading and list
                    var heading = Array.prototype.find.call(root.querySelectorAll('h1,h2,h3,h4,h5,h6'), function(h){
                        return /recursos externos/i.test(h.textContent || '');
                    });
                    var list = null;
                    if (heading) {
                        // look for next UL after heading
                        var el = heading.nextElementSibling;
                        while (el && el.tagName && el.tagName.toLowerCase() !== 'ul') el = el.nextElementSibling;
                        if (el && el.tagName && el.tagName.toLowerCase() === 'ul') list = el;
                    }
                    if (!heading) {
                        heading = document.createElement('h3');
                        heading.textContent = 'Recursos externos';
                        root.appendChild(heading);
                    }
                    if (!list) {
                        list = document.createElement('ul');
                        list.className = 'external-resources-list';
                        heading.insertAdjacentElement('afterend', list);
                    }
                    return { heading: heading, list: list };
                }
                function listContains(list, name, url){
                    var items = list.querySelectorAll('li');
                    for (var i=0;i<items.length;i++){
                        var a = items[i].querySelector('a');
                        var text = (a ? a.textContent : items[i].textContent || '').trim();
                        var href = (a ? a.getAttribute('href') : '') || '';
                        if ((url && href === url) || (name && text === name)) return true;
                    }
                    return false;
                }
                function addExternalResource(name, url){
                    if (!name) return false;
                    var current = getEditorHtml();
                    var container = htmlToDiv(current);
                    var block = findOrCreateResourcesBlock(container);
                    // Dedupe check
                    if (url && listContains(block.list, null, url)) { notify('El recurso ya fue agregado.', 'warn'); return false; }
                    if (!url && listContains(block.list, name, null)) { notify('El recurso ya fue agregado.', 'warn'); return false; }
                    var li = document.createElement('li');
                    if (url) {
                        var a = document.createElement('a');
                        a.href = url; a.textContent = name; a.target = '_blank'; a.rel = 'noopener';
                        li.appendChild(a);
                    } else {
                        li.textContent = name;
                    }
                    block.list.appendChild(li);
                    setEditorHtml(container.innerHTML);
                    notify('Recurso agregado.', 'info');
                    return true;
                }
                function onAddClick(ev){
                    ev.preventDefault(); ev.stopPropagation();
                    var btn = ev.currentTarget || ev.target;
                    var name = btn.getAttribute('data-name') || '';
                    var url = btn.getAttribute('data-url') || '';
                    if (!name) return;
                    addExternalResource(name, url);
                }
                function bindAddButtons(context){
                    var ctx = context || document;
                    ctx.querySelectorAll('.dspace-section .add-as-url').forEach(function(btn){
                        if (btn.__boundAdd) return; btn.__boundAdd = true;
                        btn.addEventListener('click', onAddClick);
                    });
                }
                // Limpia atributos no permitidos por el filtro HTML de Sakai antes de enviar el formulario
                function sanitizeEditorContent(){
                    try {
                        var html = getEditorHtml();
                        if (!html) return;
                        var d = htmlToDiv(html);
                        // Remover atributo download de todos los <a>
                        Array.prototype.forEach.call(d.querySelectorAll('a[download]'), function(a){
                            a.removeAttribute('download');
                        });
                        setEditorHtml(d.innerHTML);
                    } catch(e){ /* no-op */ }
                }
                function bindFormSanitizer(){
                    var form = document.getElementById('newAssignmentForm');
                    if (!form || form.__dspaceSanitizerBound) return;
                    form.__dspaceSanitizerBound = true;
                    form.addEventListener('submit', function(){
                        sanitizeEditorContent();
                    });
                }
                if (document.readyState === 'loading'){
                    document.addEventListener('DOMContentLoaded', function(){
                        bindAddButtons(document);
                        bindFormSanitizer();
                    });
                } else {
                    bindAddButtons(document);
                    bindFormSanitizer();
                }
            })();
        </script>

        <!-- fin Dspace Section -->

        <h4>
            $tlang.getString("gen.availability")
        </h4>

		#if ($visible_date_enabled)
		<div class="form-group row visible-date">
 			<div id="tempVisibleDate" >
				<label for="allowVisibleDateToggle" class="col-sm-2 control-label">
                    $tlang.getString("allowVisibleDate")
				</label>
				<div class="col-sm-10">
					<input type="checkbox" id="allowVisibleDateToggle" name="allowVisibleDateToggle" #if($!new_assignment_visibletoggle)checked="checked"#end onclick="ASN.changeVisibleDate();" />
				</div>
			</div>
		</div>
		<div class="form-group row visibleDatePanel" #if(!$!new_assignment_visibletoggle)style="display:none;"#end>
			<label class="col-sm-2 form-control-label">
				$tlang.getString("gen.visible.date")
			</label>
			<div class="col-sm-6 form-inline">
				<sakai-date-picker
					label="$tlang.getString("gen.visible.date")"
					hidden-prefix="new_assignment_visible_"
					iso-date="$value_VisibleYear$H$value_VisibleMonth$H$value_VisibleDay$T$value_VisibleHour:$value_VisibleMin"
					add-hidden-fields>
				</sakai-date-picker>
				<p class="text-muted small visibleDatePanel" #if(!$!new_assignment_visibletoggle)style="display:none;"#end>
					$tlang.getString("gen.stuwonsee")
				</p>
			</div>
		</div>
		#end

		<div class="form-group row form-required">
			<label for="opendate" class="col-sm-2 form-control-label">
				$tlang.getString("newassig.opedat")
			</label>
			<div class="col-sm-3 form-inline">
			    <div class="d-flex align-items-center">
					<sakai-date-picker
						id="opendate"
						label="$tlang.getString("newassig.opedat")"
						hidden-prefix="new_assignment_open_"
						iso-date="$value_OpenYear$H$value_OpenMonth$H$value_OpenDay$T$value_OpenHour:$value_OpenMin"
						add-hidden-fields>
					</sakai-date-picker>
				</div>	
				<p class="text-muted small">
					$tlang.getString("gen.stucantdo")
				</p>
			</div>
		</div>

		<div class="form-group row form-required">
			<label for="duedate" class="col-sm-2 form-control-label">
				$tlang.getString("gen.duedat")
			</label>
			<div class="col-sm-3 form-inline">
				<div class="d-flex align-items-center">
					<sakai-date-picker
						id="duedate"
						label="$tlang.getString("gen.duedat")"
						hidden-prefix="new_assignment_due_"
						iso-date="$value_DueYear$H$value_DueMonth$H$value_DueDay$T$value_DueHour:$value_DueMin"
						add-hidden-fields>
					</sakai-date-picker>
				</div>	
			</div>
 		</div>

		<div class="form-group row form-required">
			<label for="closedate" class="col-sm-2 form-control-label">
				$tlang.getString("gen.acesubunt")
			</label>
			#if ($value_EnableCloseDate)
			<div class="col-sm-3 form-inline">
			    <div class="d-flex align-items-center">
					<sakai-date-picker
						id="closedate"
						label="$tlang.getString("gen.acesubunt")"
						hidden-prefix="new_assignment_close_"
						iso-date="$value_CloseYear$H$value_CloseMonth$H$value_CloseDay$T$value_CloseHour:$value_CloseMin"
						add-hidden-fields>
					</sakai-date-picker>
				</div>
				<p class="text-muted small">
					$tlang.getString("gen.noasscan")
				</p>
			</div>
 			#else
				<select name="$name_CloseMonth" id="$name_CloseMonth" title="$tlang.getString("dateselectionwidget.month")" disabled="disabled">
					#foreach ($i in [1..12])
						#if ($i == $value_CloseMonth)
							<option value="$i" selected="selected">$monthTable.get($i)</option>
						#else
							<option value="$i">$monthTable.get($i)</option>
						#end
					#end
				</select>
                <label class="skip" for="$name_CloseDay">$tlang.getString("dateselectionwidget.day")</label>
				<select name="$name_CloseDay" id="$name_CloseDay" title="$tlang.getString("dateselectionwidget.day")" disabled="disabled">
					#foreach ($i in [1..31])
						#if ($i == $value_CloseDay)
							<option value="$i" selected="selected">$i</option>
						#else
							<option value="$i">$i</option>
						#end
					#end
				</select>
                <label class="skip" for="$name_CloseYear">$tlang.getString("dateselectionwidget.year")</label>
				<select name="$name_CloseYear" id="$name_CloseYear" title="$tlang.getString("dateselectionwidget.year")" disabled="disabled">
					#foreach ($i in [$!value_year_from..$!value_year_to])
						#if ($i == $value_CloseYear)
							<option value="$i" selected="selected">$i</option>
						#else
							<option value="$i">$i</option>
						#end
					#end
				</select>
				&nbsp;$tlang.getString("gen.at")&nbsp;
                <label class="skip" for="$name_CloseHour">$tlang.getString("dateselectionwidget.hour")</label>
				<select name="$name_CloseHour" id="$name_CloseHour" title="$tlang.getString("dateselectionwidget.hour")" disabled="disabled">
					#foreach ($i in [1..12])
						#if ($i == $value_CloseHour)
							<option value="$i" selected="selected">$i</option>
						#else
							<option value="$i">$i</option>
						#end
					#end
				</select>
                <label class="skip" for="$name_CloseMin">$tlang.getString("dateselectionwidget.minute")</label>
				<select name="$name_CloseMin" id="$name_CloseMin" title="$tlang.getString("dateselectionwidget.minute")" disabled="disabled">
					#foreach ($i in [00, 05, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55])
						<option value="$i" #if($i == $value_CloseMin)selected="selected"#end>#if($i ==0)00#elseif($i == 5)05#else$i#end</option>
					#end
				</select>
                <label class="skip" for="$name_CloseAMPM">$tlang.getString("dateselectionwidget.ampm")</label>
				<select name="$name_CloseAMPM" id="$name_CloseAMPM" title="$tlang.getString("dateselectionwidget.ampm")" disabled="disabled">
					#foreach ($i in ["AM", "PM"])
						#if ($i == $value_CloseAMPM)
							<option value="$i" selected="selected">$i</option>
						#else
							<option value="$i">$i</option>
						#end
					#end
				</select>
			#end
		</div>
		<div class="checkbox" id="div_$name_CheckEmailReminder">
			<label for="$name_CheckEmailReminder">
				<input type="checkbox" name="$name_CheckEmailReminder" id="$name_CheckEmailReminder" value="true" 
				#if ($!value_CheckEmailReminder)
					checked="checked"
				#end
				/>
				$tlang.getFormattedMessage("gen.ass.remind", $value_reminder_hours)
			</label>
		</div>
		<div class="checkbox">
			<label for="$name_CheckHideDueDate">
				<input id="$name_CheckHideDueDate" name="$name_CheckHideDueDate" type="checkbox" value="true"
				#if ($!value_CheckHideDueDate)
                       checked="checked"
				#end
                />
				$tlang.getString("gen.hideduedate")
			</label>
		</div>

		#if ($!name_CheckAddDueDate)
			<div class="checkbox">
				<label for="$name_CheckAddDueDate">
				#if ($value_CheckAddDueDate.equals("true"))
					<input id="$name_CheckAddDueDate" name="$name_CheckAddDueDate" type="checkbox" value="true" checked="checked" />
				#else
					<input id="$name_CheckAddDueDate" name="$name_CheckAddDueDate" type="checkbox" value="true" />
				#end
					$tlang.getString("gen.addduedat")
				</label>
			</div>
		#end

		#if ($!name_CheckAutoAnnounce)
			<div class="checkbox" id="div_$name_CheckAutoAnnounce">
				<label for="$name_CheckAutoAnnounce">
				#if ($value_CheckAutoAnnounce.equals("true"))
					<input id="$name_CheckAutoAnnounce" name="$name_CheckAutoAnnounce" type="checkbox" value="true" checked="checked" onclick="ASN.toggleAutoAnnounceOptions(this.checked)" />
				#else
					<input id="$name_CheckAutoAnnounce" name="$name_CheckAutoAnnounce" type="checkbox" value="true" onclick="ASN.toggleAutoAnnounceOptions(this.checked)" />
				#end
					$tlang.getString("gen.anntheope")
				</label>
			</div>

			#if ($value_CheckAutoAnnounce)
			<div id="selectAutoAnnounceOptions" class="indnt3">
			#else
			<div id="selectAutoAnnounceOptions" style="display:none" class="indnt3">
			#end
				<div class="col-sm-offset-1">
					<select name="$name_OpenDateNotification" id="$name_OpenDateNotification">
						<option value="$value_opendate_notification_none" #if($value_OpenDateNotification.equals($value_opendate_notification_none)) selected="selected" #end>$tlang.getString('send.notification.opendate.email.none')</option>
						<option value="$value_opendate_notification_low" #if($value_OpenDateNotification.equals($value_opendate_notification_low)) selected="selected" #end>$tlang.getString('send.notification.opendate.email.low')</option>
						<option value="$value_opendate_notification_high" #if($value_OpenDateNotification.equals($value_opendate_notification_high)) selected="selected" #end>$tlang.getString('send.notification.opendate.email.high')</option>
					</select>
				</div>
			</div>
		#end

		<h4>
			$tlang.getString("gen.stusub")
		</h4>
		<div class="form-group row form-required">
			<label for="subType" class="col-sm-2 form-control-label">
				$tlang.getString("gen.submissionType")
			</label>
			<div class="col-sm-6">
				<select name="$name_SubmissionType" id="subType" onchange="switchAssignmentSubmissionType();" class="assignment-submission-type">
				#foreach ($i in [1..$!value_totalSubmissionTypes])
					#if ($i == $value_SubmissionType)
						<option value="$i" selected="selected">$submissionTypeTable.get($i)</option>
					#else
						<option value="$i">$submissionTypeTable.get($i)</option>
					#end
				#end
				</select>
			</div>
			<div id="review.switch.ne.2" class="sak-banner-info" style="display:none;">$reviewSwitchNe2</div>
		</div>

		<div id="External_Tool_Fieldset" #if ($value_SubmissionType != 6) style = "display:none"#end>
        <fieldset>
		<h4>
			$tlang.getString("external.tool.label")
		</h4>
		<p class="sak-banner-info">
			$tlang.getString("external.tool.detail")
        </p>
		<div class="form-group row">
			<label class="col-sm-12 control-label block" for="tempContentId">
				$tlang.getString("launchContentId")
			</label>
			<div class="col-sm-6" id="tempContentId">
					<input type="text" readonly id="returnToolTitle" name="$name_ContentTitle" size="30"
                        class="form-control" maxlength="100"
                        placeholder="$tlang.getString('external.tool.placeholder')" value="$!value_ContentTitle">
					<input type="hidden" id="returnContentId" name="$name_ContentId" value="$value_ContentId">
                    <script>
                        window.returnContentItem = function (contentItem) {
                            console.log("returnContentItem", contentItem);
                            if ( ! Array.isArray(contentItem) ) return;
                            if ( contentItem.length != 1 ) return;
                            var item = contentItem[0];
                            console.log("item", item);
                            // Strangely, https://www.sakailms.org/spec/lti-ags/v2p0/releaseToStudent does not have an analog in Assignments
                            // Content Item Variant
                            if ( item && item.lineItem && item.lineItem.scoreConstraints ) {
                                var scoreConstraints = item.lineItem.scoreConstraints;
                                console.log("item.lineItem.scoreConstraints", scoreConstraints);
                                if ( scoreConstraints.normalMaximum  ) {
                                    $("#new_assignment_grade_points").val(scoreConstraints.normalMaximum);
                                }
                                if ( scoreConstraints.totalMaximum  ) {
                                    $("#new_assignment_grade_points").val(scoreConstraints.totalMaximum);
                                }
                            }

                            // Deep Linking variant
                            if ( item && item.lineItem && item.lineItem.scoreMaximum ) {
                                $("#new_assignment_grade_points").val(item.lineItem.scoreMaximum);
                            }

                            // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Intl/DateTimeFormat/DateTimeFormat
                            // https://stackoverflow.com/a/63160519/1994792
                            var options = {year: 'numeric', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit'};
                            if ( item && item.submission ) {
                                var submission = item.submission;
                                if ( submission.startDateTime ) {
                                    var tdate = new Date(submission.startDateTime);
                                    tdate = tdate.toLocaleString([], options).replace(',','');
                                    $("#opendate").val(tdate);
                                }
                                if ( submission.endDateTime ) {
                                    var tdate = new Date(submission.endDateTime);
                                    tdate = tdate.toLocaleString([], options).replace(',','');
                                    $("#duedate").val(tdate);
                                }
                            }
                            if ( item && item.available ) {
                                var available = item.available;
                                if ( available.startDateTime ) {
                                    var tdate = new Date(available.startDateTime);
                                    tdate = tdate.toLocaleString([], options).replace(',','');
                                    $("#opendate").val(tdate);
                                }
                                if ( available.endDateTime ) {
                                    var tdate = new Date(available.endDateTime);
                                    tdate = tdate.toLocaleString([], options).replace(',','');
                                    $("#closedate").val(tdate);
                                }
                            }
                        };
                        window.returnContentTitle = function (newTitle) {
                            setTimeout(function(){
                                if ( confirm('$tlang.getString("launchContentTitle")'+" "+newTitle) ) {
                                    $("#new_assignment_title").val(newTitle);
                                }
                            }, 500);
                        };
                    </script>
			</div>
        </div>
		<div class="form-group row">
			<div class="col-sm-6">
                    <a title="$tlang.getString('external.tool.find')" target="sakai-basiclti-admin-iframe" onclick="showExternalIframe(this.title, false);"
                        class="btn btn-primary" role="button"
                        href="$findExternalToolUrl">$tlang.getString('external.tool.find')</a>
            </div>
		</div>

		<div class="checkbox">
			<label for="$name_ContentLaunchNewWindow">
			#if ($!value_ContentLaunchNewWindow == true)
				<input id="$name_ContentLaunchNewWindow" name="$name_ContentLaunchNewWindow" type="checkbox" value="true" checked="checked" />
			#else
				<input id="$name_ContentLaunchNewWindow" name="$name_ContentLaunchNewWindow" type="checkbox" value="true" />
			#end
				$tlang.getString("launchContentNewWindow")
			</label>
		</div>
		</fieldset>
        </div>
        <div id="external-modal-iframe-div" style="display:none" tabindex="-1" role="dialog">
            <iframe name="sakai-basiclti-admin-iframe" id="sakai-basiclti-admin-iframe" src="/library/image/sakai/spinner.gif" tabindex="0"></iframe>
        </div>
<style>
.ui-widget-overlay.ui-front {
    opacity:.75;
}
</style>
<script>
//<![CDATA[
function showExternalIframe(title, doreload) {
    $("#external-modal-iframe-div").dialog({
        title: title,
        width: modalDialogWidth(),
        height: modalDialogHeight(),
        modal: true,
        draggable: false,
        open: function() {
            $("#external-modal-iframe-div").dialog("option", "width", modalDialogWidth());
            $("#external-modal-iframe-div").dialog("option", "height", modalDialogHeight());
            $('#sakai-basiclti-admin-iframe').attr('width', '100%');
            $('#sakai-basiclti-admin-iframe').attr('height', '100%');
            // https://stackoverflow.com/questions/1202079/prevent-jquery-ui-dialog-from-setting-focus-to-first-textbox
            $(this).parent().focus();
        },
        close: function() {
            if ( doreload ) {
                location.reload();
            } else {
                $('#sakai-basiclti-admin-iframe').attr('src','/library/image/sakai/spinner.gif');
            }
        }
    });

    $(window).resize(function() {
        $("#external-modal-iframe-div").dialog("option", "width", modalDialogWidth());
        $("#external-modal-iframe-div").dialog("option", "height", modalDialogHeight());
        $('#sakai-basiclti-admin-iframe').attr('width', '100%');
        $('#sakai-basiclti-admin-iframe').attr('height', '100%');
    });
}
//]]>
</script>

		#if ($!isTimesheet)
			<div id="timesheetsetupsection">
				<h4>
					$tlang.getString("gen.estimate")
				</h4>

				<div class="checkbox">
					<label for="$name_NEW_ASSIGNMENT_CHECK_ADD_ESTIMATE">
						<input id="$name_NEW_ASSIGNMENT_CHECK_ADD_ESTIMATE" name="$name_NEW_ASSIGNMENT_CHECK_ADD_ESTIMATE" type="checkbox" value="true" #if ($value_NEW_ASSIGNMENT_CHECK_ADD_ESTIMATE) checked #end onclick="ASN.toggleAutoAnnounceEstimate(this.checked)" />
						$tlang.getString("gen.isestimate")
					</label>
				</div>

				<div id="checkestimaterequired" class="checkbox hidden">
					<label for="$name_NEW_ASSIGNMENT_CHECK_ADD_ESTIMATE_REQUIRED">
						<input id="$name_NEW_ASSIGNMENT_CHECK_ADD_ESTIMATE_REQUIRED" name="$name_NEW_ASSIGNMENT_CHECK_ADD_ESTIMATE_REQUIRED" type="checkbox" value="true" #if ($value_NEW_ASSIGNMENT_CHECK_ADD_ESTIMATE_REQUIRED) checked #end />
						$tlang.getString("gen.reqestimate")
					</label>
				</div>

				<div id="inputtimestimate" class="form-group row form-required hidden">
						<label for="$name_NEW_ASSIGNMENT_INPUT_ADD_TIME_ESTIMATE" class="col-sm-2 form-required">
							$tlang.getString("gen.timestimate")
						</label>
						<div class="col-sm-2">
							<input name="$name_NEW_ASSIGNMENT_INPUT_ADD_TIME_ESTIMATE" id="$name_NEW_ASSIGNMENT_INPUT_ADD_TIME_ESTIMATE" type="text" value="$formattedText.escapeHtml($!value_NEW_ASSIGNMENT_INPUT_ADD_TIME_ESTIMATE)" size="20" maxlength="20" class="form-control" placeholder="$!tlang.getString('ts.modal.field.tspent.format')" />
						</div>
				</div>
			</div>
			#if ($value_AssignTo == $value_AssignTo_Groups && $!groupsList && !$selectedGroupsNotFound)
			<script>
				ASN.disableTimesheetSetupSection();
			</script>
			#end
		#end

        <fieldset id="assignToSection" #if ($value_SubmissionType == 6) style = "display:none"#end>
		<h4>$!tlang.getString('accessSectionHeader')</h4>
		#parse("vm/assignment/instructor_new_edit/assignto_section.vm")
		</fieldset>

		##show it only for those assignments not of type non-electronic submission
		#if($!value_allowResubmitNumber && $value_SubmissionType != 4)
			#set($resubmitStyle="display:block")
		#else
			#set($resubmitStyle="display:none")
		#end

		<div id="allowResubmissionContainer" class="form-group" #if ($value_SubmissionType == 4) style = "display:none"#end>
			<label class="form-control-label h4" for="allowResToggle">
				$tlang.getString("allowResubmit")
			</label>
			<div class="d-inline-block ml-25">
				<div id="tempAllowRes">
					<input type="checkbox" id="allowResToggle" name ="allowResToggle" #if($!value_allowResubmitNumber) checked="checked"#end onclick="ASN.changeResubmissionDate()" />
				</div>
			</div>
		    <p class="sak-banner-info" id="ltiSubmissionResubmitNote" #if ($value_SubmissionType != 6) style = "display:none"#end>
			    $tlang.getString("external.tool.resubmission")
            </p>
		</div>

		<div class="form-group row ms-3" id="allowResubmitNumber" style="$!resubmitStyle">
			<label for="allowResubmitNumberSelect" class="col-sm-offset-1 col-sm-3 control-label">
				$tlang.getString("allow.resubmit.number")
			</label>
			<div class="col-sm-9">
				<select name="$name_allowResubmitNumber" id="allowResubmitNumberSelect" title="$tlang.getString("allow.resubmit.number")">
					#foreach ($i in [1..10])
						<option value="$i" #if($i==$!value_allowResubmitNumber)selected="selected"#end>
							$i
						</option>
					#end
					<option value="-1" #if($!value_allowResubmitNumber == -1)selected="selected"#end>$tlang.getString("allow.resubmit.number.unlimited")</option>
				</select>
			</div>
		</div>

		## only show date selection when allowed to resubmit
		<div class="form-group row ms-3" id="allowResubmitTime" style="$!resubmitStyle">
			<label for="$name_ResubmitMonth" class="col-sm-offset-1 col-sm-2 control-label">
				$tlang.getString("gen.resubmission") $tlang.getString("gen.acesubunt")
			</label>
			<div class="col-sm-6 form-inline">
				<sakai-date-picker
					id="resubmissiondate"
					label="$tlang.getString("gen.resubmission") $tlang.getString("gen.acesubunt")"
					hidden-prefix="allow_resubmit_close_"
					iso-date="$value_ResubmitYear$H$value_ResubmitMonth$H$value_ResubmitDay$T$value_ResubmitHour:$value_ResubmitMin"
					add-hidden-fields>
				</sakai-date-picker>
			</div>
		</div>

		<div class="col-sm-offset-1 row ms-3" id="resubmitNotification" style="$!resubmitStyle">
			<strong>
				$tlang.getString("send.submission.releasereturn.email.options")
			</strong>
			## whether to notify student about released grade and resubmission is available
			<div class="radio">
				<label>
					<input type="radio" name="$!name_assignment_releasereturn_notification" id="notsendreleasereturnnotif" value="$!value_assignment_releasereturn_notification_none" #if($!value_assignment_releasereturn_notification.equals($!value_assignment_releasereturn_notification_none))checked="checked" #end />
					$tlang.getString('send.submission.releasereturn.email.none')
				</label>
			</div>
			<div class="radio">
				<label>
					<input type="radio" name="$!name_assignment_releasereturn_notification" id="sendreleasereturnnotif" value="$!value_assignment_releasereturn_notification_each" #if($!value_assignment_releasereturn_notification.equals($!value_assignment_releasereturn_notification_each))checked="checked" #end />
					$tlang.getString('send.submission.releasereturn.email')
				</label>
			</div>
		</div>

		## whether to show the instructor notification choices
		#if ($!name_assignment_instructor_notifications)
		<fieldset id="notificationOptions" #if ($value_SubmissionType == 6) style = "display:none"#end>
			<h4>
				$tlang.getString("receive.confirm.submission.email.options")
			</h4>
			<div class="radio">
    				<label for="notsendnotif">
				<input type="radio" name="$!name_assignment_instructor_notifications" id="notsendnotif" value="$!value_assignment_instructor_notifications_none" #if($!value_assignment_instructor_notifications.equals($!value_assignment_instructor_notifications_none))checked="checked" #end />
					$tlang.getString('receive.confirm.submission.email.none')
				</label>
    			</div>
			<div class="radio">
    				<label for="sendnotif">
    				<input type="radio" name="$!name_assignment_instructor_notifications" id="sendnotif" value="$!value_assignment_instructor_notifications_each" #if($!value_assignment_instructor_notifications.equals($!value_assignment_instructor_notifications_each))checked="checked" #end />
					$tlang.getString('receive.confirm.submission.email.each')
				</label>
    			</div>
			<div class="radio">
    				<label for="sendnotifsummary">
    				<input type="radio" name="$!name_assignment_instructor_notifications" id="sendnotifsummary" value="$!value_assignment_instructor_notifications_digest" #if($!value_assignment_instructor_notifications.equals($!value_assignment_instructor_notifications_digest))checked="checked" #end />
					$tlang.getString('receive.confirm.submission.email.digest')
				</label>
    			</div>
		</fieldset>
		#end

		#if ($allowReviewService)
			<h4> $reviewServiceTitle </h4>
			<div>
				#if (4 == $value_SubmissionType)
					<div id="review.switch.ne.1" class="sak-banner-info">$reviewSwitchNe1</div>
					<div class="checkbox  indnt2">
						<label id="lblReviewService" for="$name_UseReviewService" class="instruction">
						<input id="$name_UseReviewService" name="$name_UseReviewService" type="checkbox" value="true" onclick="ASN.toggleReviewServiceOptions(this.checked)" disabled="disabled"/>

							$reviewServiceUse
						</label>
					</div>
				#else
					<div id="review.switch.ne.1" class="sak-banner-info" style="display:none;">$reviewSwitchNe1</div>
					<div class="checkbox">
						<label id="lblReviewService" for="$name_UseReviewService">
						#if($!value_UseReviewService == true)
							<input id="$name_UseReviewService" name="$name_UseReviewService" type="checkbox" value="true" checked="checked" onclick="ASN.toggleReviewServiceOptions(this.checked)"/>
						#else
							<input id="$name_UseReviewService" name="$name_UseReviewService" type="checkbox" value="true" onclick="ASN.toggleReviewServiceOptions(this.checked)"/>
						#end

							$reviewServiceUse
						</label>
					</div>
				#end

				#if ($!value_UseReviewService == true && $!value_SubmissionType != 4)
					<div id="reviewServiceOptions" class="indnt3">
				#else
					<div id="reviewServiceOptions" style="display:none" class="indnt3">
				#end
					<div class="checkbox">
						<label for="$name_AllowStudentView">
						#if ($!value_AllowStudentView.equals("true"))
							<input id="$name_AllowStudentView" name="$name_AllowStudentView" type="checkbox" value="true" checked="checked" />
						#else
							<input id="$name_AllowStudentView" name="$name_AllowStudentView" type="checkbox" value="true" />
						#end
							$tlang.getString("review.allow")
						</label>
					</div>

					<!-- Start TII custom options -->
					#if($reviewServiceProviderId == $turnitinProviderId)

					#if ($content_review_note)
						$content_review_note
					#end

					<h4>
						$tlang.getString("review.submit.papers.repository")
					</h4>

					<div class="radio">
						#if($show_NEW_ASSIGNMENT_REVIEW_SERVICE_SUBMIT.contains($name_NEW_ASSIGNMENT_REVIEW_SERVICE_SUBMIT_NONE))
							<label><input type="radio" name="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_SUBMIT_RADIO" value="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_SUBMIT_NONE" #if($value_NEW_ASSIGNMENT_REVIEW_SERVICE_SUBMIT_RADIO.equals("$name_NEW_ASSIGNMENT_REVIEW_SERVICE_SUBMIT_NONE"))checked#end/>$tlang.getString("review.submit.papers.repository.none")</label>
						#end
						#if($show_NEW_ASSIGNMENT_REVIEW_SERVICE_SUBMIT.contains($name_NEW_ASSIGNMENT_REVIEW_SERVICE_SUBMIT_STANDARD))
							<label><input type="radio" name="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_SUBMIT_RADIO" value="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_SUBMIT_STANDARD" #if($value_NEW_ASSIGNMENT_REVIEW_SERVICE_SUBMIT_RADIO.equals("$name_NEW_ASSIGNMENT_REVIEW_SERVICE_SUBMIT_STANDARD"))checked#end/>$tlang.getString("review.submit.papers.repository.standard")</label>
						#end
						#if($show_NEW_ASSIGNMENT_REVIEW_SERVICE_SUBMIT.contains($name_NEW_ASSIGNMENT_REVIEW_SERVICE_SUBMIT_INSITUTION))
							<label><input type="radio" name="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_SUBMIT_RADIO" value="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_SUBMIT_INSITUTION" #if($value_NEW_ASSIGNMENT_REVIEW_SERVICE_SUBMIT_RADIO.equals("$name_NEW_ASSIGNMENT_REVIEW_SERVICE_SUBMIT_INSITUTION"))checked#end/>$tlang.getString("review.submit.papers.repository.institution")</label>
						#end
					</div>

					<h4>
						$tlang.getString("review.originality.reports")
					</h4>

					<div class="radio">
						#if($show_NEW_ASSIGNMENT_REVIEW_SERVICE_REPORT.contains($name_NEW_ASSIGNMENT_REVIEW_SERVICE_REPORT_IMMEDIATELY))
							<label><input type="radio" name="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_REPORT_RADIO" value="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_REPORT_IMMEDIATELY" #if($value_NEW_ASSIGNMENT_REVIEW_SERVICE_REPORT_RADIO.equals("$name_NEW_ASSIGNMENT_REVIEW_SERVICE_REPORT_IMMEDIATELY"))checked#end/>$tlang.getString("review.originality.reports.immediately")</label>
						#end
						#if($show_NEW_ASSIGNMENT_REVIEW_SERVICE_REPORT.contains($name_NEW_ASSIGNMENT_REVIEW_SERVICE_REPORT_DUE))
							<label><input type="radio" name="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_REPORT_RADIO" value="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_REPORT_DUE" #if($value_NEW_ASSIGNMENT_REVIEW_SERVICE_REPORT_RADIO.equals("$name_NEW_ASSIGNMENT_REVIEW_SERVICE_REPORT_DUE"))checked#end/>$tlang.getString("review.originality.reports.due")</label>
						#end
					</div>

					<br/>
					#if($show_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_BIBLIOGRAPHIC || $show_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_QUOTED || $show_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_SMALL_MATCHES)
						<h4>
							$tlang.getString("review.exclude.matches.header")
						</h4>
					#end

					<!-- Exclude Bibliographic materials -->
					#if($show_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_BIBLIOGRAPHIC)
					<div class="checkbox">
						<label for="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_BIBLIOGRAPHIC">
							#if ($!value_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_BIBLIOGRAPHIC.equals("true"))
								<input id="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_BIBLIOGRAPHIC" name="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_BIBLIOGRAPHIC" type="checkbox" value="true" checked="checked" />
							#else
								<input id="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_BIBLIOGRAPHIC" name="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_BIBLIOGRAPHIC" type="checkbox" value="true" />
							#end
								$tlang.getString("review.exclude.bibliographic")
						</label>
					</div>
					#end
					<!-- Exclude Quoted materials -->
					#if($show_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_QUOTED)
					<div class="checkbox">
						<label for="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_QUOTED">
							#if ($!value_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_QUOTED.equals("true"))
								<input id="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_QUOTED" name="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_QUOTED" type="checkbox" value="true" checked="checked" />
							#else
								<input id="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_QUOTED" name="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_QUOTED" type="checkbox" value="true" />
							#end
								$tlang.getString("review.exclude.quoted")
						</label>
					</div>
					#end
					<!-- Exclude small matches -->

					#if($show_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_SMALL_MATCHES)
						<div class="checkbox">
							<label for="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_TYPE">
							#if ($value_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_TYPE == 1 || $value_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_TYPE == 2)
								<input type="checkbox" value="true" name="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_SMALL_MATCHES" checked="checked" onclick="ASN.toggleSmallMatchesOptions(this.checked)"/>
							#else
								<input type="checkbox" value="true" name="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_SMALL_MATCHES" onclick="ASN.toggleSmallMatchesOptions(this.checked)"/>
							#end
								$tlang.getString("review.exclude.smallMatches")
							</label>
							<br/>
								#if ($value_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_TYPE == 1 || $value_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_TYPE == 2)
									<div id="smallMatchesOptions" class="indnt2 smallMatches" style="display:inline-block;">
								#else
									<div id="smallMatchesOptions" class="indnt2 smallMatches" style="display:none;">
								#end
								$tlang.getString("review.exclude.matches.by")<span class="reqStar">*</span>
								<br/>
								<input onchange="ASN.toggleSmallMatchesDisabled()" type="radio" name="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_TYPE" id="wordCount" value="1" #if ($value_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_TYPE ==  1) checked="checked" #end/>
								<label for="wordCount">
									$tlang.getString("review.exclude.matches.wordmax")
								</label>
								<input type="text" size="3" maxlength="3" id="tiiExcludeValueWords" name="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_VALUE" #if ($value_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_TYPE ==  1) value="$value_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_VALUE" #else disabled="disabled" #end/>
								<br/>

								<input onchange="ASN.toggleSmallMatchesDisabled()" type="radio" name="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_TYPE" id="percentage" value="2" #if ($value_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_TYPE == 2) checked="checked" #end/>
								<label for="percentage">
									$tlang.getString("review.exclude.matches.percentage")
								</label>
								<input type="text" size="3" maxlength="3" id="tiiExcludeValuePercentages" name="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_VALUE" #if ($value_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_TYPE == 2) value="$value_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_VALUE" #else disabled="disabled" #end/>
								%
								<!--end div for smallMatchesOptions -->
								</div>
						</div>
					#end

					<h4>
						$tlang.getString("review.originality.check")
					</h4>
					<div class="indnt1">
						#if($show_NEW_ASSIGNMENT_REVIEW_SERVICE_CHECK_TURNITIN)
						<div class="checkbox">
							<label for="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_CHECK_TURNITIN">
							#if ($!value_NEW_ASSIGNMENT_REVIEW_SERVICE_CHECK_TURNITIN.equals("true"))
								<input id="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_CHECK_TURNITIN" name="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_CHECK_TURNITIN" type="checkbox" value="true" checked="checked" />
							#else
								<input id="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_CHECK_TURNITIN" name="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_CHECK_TURNITIN" type="checkbox" value="true" />
							#end
								$tlang.getString("review.originality.check.turnitin")
							</label>
						</div>
						#end
						#if($show_NEW_ASSIGNMENT_REVIEW_SERVICE_CHECK_INTERNET)
						<div class="checkbox">
							<label for="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_CHECK_INTERNET">
							#if ($!value_NEW_ASSIGNMENT_REVIEW_SERVICE_CHECK_INTERNET.equals("true"))
								<input id="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_CHECK_INTERNET" name="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_CHECK_INTERNET" type="checkbox" value="true" checked="checked" />
							#else
								<input id="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_CHECK_INTERNET" name="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_CHECK_INTERNET" type="checkbox" value="true" />
							#end
								$tlang.getString("review.originality.check.internet")
							</label>
						</div>
						#end
						#if($show_NEW_ASSIGNMENT_REVIEW_SERVICE_CHECK_PUB)
						<div class="checkbox">
							<label for="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_CHECK_PUB">
							#if ($!value_NEW_ASSIGNMENT_REVIEW_SERVICE_CHECK_PUB.equals("true"))
								<input id="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_CHECK_PUB" name="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_CHECK_PUB" type="checkbox" value="true" checked="checked" />
							#else
								<input id="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_CHECK_PUB" name="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_CHECK_PUB" type="checkbox" value="true" />
							#end
								$tlang.getString("review.originality.check.pub")
							</label>
						</div>
						#end
						#if($show_NEW_ASSIGNMENT_REVIEW_SERVICE_CHECK_INSTITUTION)
						<div class="checkbox">
							<label for="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_CHECK_INSTITUTION">
							#if ($!value_NEW_ASSIGNMENT_REVIEW_SERVICE_CHECK_INSTITUTION.equals("true"))
								<input id="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_CHECK_INSTITUTION" name="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_CHECK_INSTITUTION" type="checkbox" value="true" checked="checked" />
							#else
								<input id="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_CHECK_INSTITUTION" name="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_CHECK_INSTITUTION" type="checkbox" value="true" />
							#end
								$tlang.getString("review.originality.check.institution")
							</label>
						</div>
						#end
					</div>
				<!-- End TII custom options -->
					#elseif($reviewServiceProviderId == $turnitinOCProviderId)
						<!-- Start TurnitinOC custom options -->
						
						#if($show_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_BIBLIOGRAPHIC || $show_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_QUOTED)
							<br/>
							<div>
								<label>$tlang.getString("turnitinoc.exclude.header"):</label>
							</div>
							<div style="display:inline-block">
								<!-- Exclude Bibliographic materials -->
								#if($show_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_BIBLIOGRAPHIC)
									<div class="checkbox">
										<label for="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_BIBLIOGRAPHIC">
											#if ($!value_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_BIBLIOGRAPHIC.equals("true"))
												<input id="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_BIBLIOGRAPHIC" name="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_BIBLIOGRAPHIC" type="checkbox" value="true" checked="checked" />
											#else
												<input id="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_BIBLIOGRAPHIC" name="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_BIBLIOGRAPHIC" type="checkbox" value="true" />
											#end
											$tlang.getString("turnitinoc.exclude.bibliography")
										</label>
									</div>
								#end
								<!-- Exclude Quoted materials -->
								#if($show_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_QUOTED)
		                            <div class="checkbox">
		                                <label for="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_QUOTED">
											#if ($!value_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_QUOTED.equals("true"))
		                                        <input id="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_QUOTED"
		                                               name="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_QUOTED"
		                                               type="checkbox" value="true" checked="checked"/>
											#else
		                                        <input id="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_QUOTED"
		                                               name="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_EXCLUDE_QUOTED"
		                                               type="checkbox" value="true"/>
											#end
											$tlang.getString("turnitinoc.exclude.quoted")
		                                </label>
		                            </div>
								#end
							</div>
						#end
						
						#if($show_NEW_ASSIGNMENT_REVIEW_SERVICE_STORE_INST_INDEX)
							<br/><br/>
							<div>
								<label>$tlang.getString("turnitinoc.index.header"):</label>
								<p class="text-muted small">
									$tlang.getString("turnitinoc.index.info")
								</p>
							</div>
							<div style="display:inline-block">
		                        <!-- Store Inst Index -->
								#if($show_NEW_ASSIGNMENT_REVIEW_SERVICE_STORE_INST_INDEX)
		                            <div class="checkbox">
		                                <label for="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_STORE_INST_INDEX">
											#if ($!value_NEW_ASSIGNMENT_REVIEW_SERVICE_STORE_INST_INDEX.equals("true"))
		                                        <input id="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_STORE_INST_INDEX"
		                                               name="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_STORE_INST_INDEX"
		                                               type="checkbox" value="true" checked="checked"/>
											#else
		                                        <input id="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_STORE_INST_INDEX"
		                                               name="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_STORE_INST_INDEX"
		                                               type="checkbox" value="true"/>
											#end
											$tlang.getString("turnitinoc.index.all")
		                                </label>
		                             </div>
								#end
							</div>
						#end
						
						
						#if($show_NEW_ASSIGNMENT_REVIEW_SERVICE_REPORT)
						 	<br/><br/>
							<div>
								<label>$tlang.getString("turnitinoc.generate.header"):</label>
							</div>
							<div style="display:inline-block">
								#if($show_NEW_ASSIGNMENT_REVIEW_SERVICE_REPORT.contains($name_NEW_ASSIGNMENT_REVIEW_SERVICE_REPORT_IMMEDIATELY))
									<div class="radio">
										<label><input type="radio" name="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_REPORT_RADIO" value="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_REPORT_IMMEDIATELY" #if($value_NEW_ASSIGNMENT_REVIEW_SERVICE_REPORT_RADIO.equals("$name_NEW_ASSIGNMENT_REVIEW_SERVICE_REPORT_IMMEDIATELY"))checked#end/>$tlang.getString("review.originality.reports.immediately")</label>
									</div>
								#end
								#if($show_NEW_ASSIGNMENT_REVIEW_SERVICE_REPORT.contains($name_NEW_ASSIGNMENT_REVIEW_SERVICE_REPORT_DUE))
									<div class="radio">
										<label><input type="radio" name="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_REPORT_RADIO" value="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_REPORT_DUE" #if($value_NEW_ASSIGNMENT_REVIEW_SERVICE_REPORT_RADIO.equals("$name_NEW_ASSIGNMENT_REVIEW_SERVICE_REPORT_DUE"))checked#end/>$tlang.getString("review.originality.reports.due")</label>
									</div>
								#end
								#if($show_NEW_ASSIGNMENT_REVIEW_SERVICE_REPORT.contains($name_NEW_ASSIGNMENT_REVIEW_SERVICE_REPORT_IMMEDIATELY_AND_DUE))
									<div class="radio">
										<label><input type="radio" name="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_REPORT_RADIO" value="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_REPORT_IMMEDIATELY_AND_DUE" #if($value_NEW_ASSIGNMENT_REVIEW_SERVICE_REPORT_RADIO.equals("$name_NEW_ASSIGNMENT_REVIEW_SERVICE_REPORT_IMMEDIATELY_AND_DUE"))checked#end/>$tlang.getString("review.originality.reports.immediately_and_due")</label>
									</div>
								#end
							</div>
						#end
						<br/><br/>
						<p class="text-muted small">
							<a href="$tlang.getString("turnitinoc.instructions.url")" rel="noreferrer" target="_blank">$tlang.getString("turnitinoc.instructions")</a>
						</p>
                        <!-- End TurnitinOC custom options -->
				#elseif($reviewServiceName.equals("Compilatio"))
						#if ($content_review_note)
							$content_review_note
						#end
						<h4>
							$tlang.getString("review.originality.reports")
						</h4>
						<div class="radio">
							#if($show_NEW_ASSIGNMENT_REVIEW_SERVICE_REPORT.contains($name_NEW_ASSIGNMENT_REVIEW_SERVICE_REPORT_IMMEDIATELY))
								<label for="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_REPORT_RADIO">
									<input type="radio" name="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_REPORT_RADIO" value="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_REPORT_IMMEDIATELY" #if($value_NEW_ASSIGNMENT_REVIEW_SERVICE_REPORT_RADIO.equals("$name_NEW_ASSIGNMENT_REVIEW_SERVICE_REPORT_IMMEDIATELY"))checked#end/>$tlang.getString("review.originality.reports.immediately")<br/>
								</label>
								<br/>
							#end
							#if($show_NEW_ASSIGNMENT_REVIEW_SERVICE_REPORT.contains($name_NEW_ASSIGNMENT_REVIEW_SERVICE_REPORT_DUE))
								<label for="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_REPORT_RADIO">
									<input type="radio" name="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_REPORT_RADIO" value="$name_NEW_ASSIGNMENT_REVIEW_SERVICE_REPORT_DUE" #if($value_NEW_ASSIGNMENT_REVIEW_SERVICE_REPORT_RADIO.equals("$name_NEW_ASSIGNMENT_REVIEW_SERVICE_REPORT_DUE"))checked#end/>$tlang.getString("review.originality.reports.due")<br/>
								</label>
							#end
						</div>
				<!-- End Compilatio custom options -->
				#elseif($reviewServiceName.equals("Urkund"))
						#if ($content_review_note)
							$content_review_note
						#end
				<!-- End Urkund custom options -->
				#end
			</div>
			</div>
		#end
		#if($enableAnonGrading || $value_CheckAnonymousGrading)
			<h4>$!tlang.getString('grading')</h4>
		#end

		#parse("vm/assignment/instructor_new_edit/grading_section.vm")

		## whether to notify student about released grade
		<fieldset id="releaseGradeNotifications" #if ($value_SubmissionType == 6) style = "display:none"#end>
			<h4>
				$tlang.getString("send.submission.releasegrade.email.options")
			</h4>
			<div class="radio">
				<label for="notsendreleasegradenotif">
				<input type="radio" name="$!name_assignment_releasegrade_notification" id="notsendreleasegradenotif" value="$!value_assignment_releasegrade_notification_none" #if($!value_assignment_releasegrade_notification.equals($!value_assignment_releasegrade_notification_none))checked="checked" #end />
					$tlang.getString('send.submission.releasegrade.email.none')
				</label>
			</div>
			<div class="radio">
				<label for="sendreleasegradenotif">
				<input type="radio" name="$!name_assignment_releasegrade_notification" id="sendreleasegradenotif" value="$!value_assignment_releasegrade_notification_each" #if($!value_assignment_releasegrade_notification.equals($!value_assignment_releasegrade_notification_each))checked="checked" #end />
					$tlang.getString('send.submission.releasegrade.email')
				</label>
			</div>
		</fieldset>

	<a name="extraNodesTop"></a>

    <div id="additionalInformation" #if ($value_SubmissionType == 6) style = "display:none"#end>
	<h4>
		$tlang.getString("additional_information")
	</h4>

	<div class="col-sm-6 row">
		<table class="table table-striped" id="extraNodeLinkList">
			<h6>$tlang.getString("supplement")</h6>
			<tr>
				<td class="col-sm-2">
					$tlang.getString("modelAnswer")
				</td>
				<td class="col-sm-4 itemAction" style="white-space:nowrap">
					<div class="col-sm-2" id="nomodelanswer"  #if(!$!modelanswer) style="display:block"#else style="display:none" #end>
						<a id="modelanswer_add" class="extraNodeLink" href="javascript:void(0)">$tlang.getString("new")<span class="skip"> $tlang.getString("modelAnswer")</span></a>
					</div>
					<div class="col-sm-2" id="hasmodelanswer"  #if($!modelanswer) style="display:block"#else style="display:none" #end>
						<a id="modelanswer_edit" class="extraNodeLink" href="javascript:void(0)">$tlang.getString("gen.revi")<span class="skip"> $tlang.getString("modelAnswer")</span></a> | <a id="modelanswer_delete" class="extraNodeLink" href="javascript:void(0)">$tlang.getString("delet")<span class="skip"> $tlang.getString("modelAnswer")</span></a>
						<input id = "modelanswer_to_delete" name = "modelanswer_to_delete" type= "hidden" value = "false" />
					</div>
				</td>
			</tr>
			## show the private note section if only the user can view or edit the item
			#if ($!allowEditAssignmentNoteItem || $!allowReadAssignmentNoteItem)
				<tr>
					<td class="col-sm-2">
						$tlang.getString("note")
					</td>
					<td class="col-sm-4 itemAction" style="white-space:nowrap">
						<div class="col-sm-2" id="nonote"  #if(!$!note) style="display:block"#else style="display:none" #end>
							<a id="note_add" class="extraNodeLink" href="javascript:void(0)">$tlang.getString("new")<span class="skip"> $tlang.getString("note")</span></a>
						</div>
						<div class="col-sm-2" id="hasnote"  #if($!note) style="display:block"#else style="display:none" #end>
							#if ($!allowEditAssignmentNoteItem)
								<a id="note_edit" class="extraNodeLink" href="javascript:void(0)">$tlang.getString("gen.revi")<span class="skip"> $tlang.getString("note")</span></a> | <a id="note_delete" class="extraNodeLink" href="javascript:void(0)">$tlang.getString("delet")<span class="skip"> $tlang.getString("note")</span></a>
							#else
								#if ($!allowReadAssignmentNoteItem)
									<a id="note_edit" class="extraNodeLink" href="javascript:void(0)">$tlang.getString("gen.view2")</a>
								#end
							#end
						</div>
						<input id = "note_to_delete" name = "note_to_delete" type= "hidden" value = "false" />
					</td>
				</tr>
			#end
			<tr>
				<td class="col-sm-2">
					$tlang.getString("allPurpose")
				</td>
				<td class="col-sm-4 itemAction" style="white-space:nowrap">
					<div class="col-sm-2" id="noallPurpose" #if(!$!allPurpose) style="display:block"#else style="display:none" #end>
						<a id="allPurpose_add" class="extraNodeLink" href="javascript:void(0)">$tlang.getString("new")<span class="skip"> $tlang.getString("allPurpose")</span></a>
					</div>
					<div class="col-sm-2" id="hasallPurpose" #if($!allPurpose) style="display:block"#else style="display:none" #end>
						<a id="allPurpose_edit" class="extraNodeLink" href="javascript:void(0)">$tlang.getString("gen.revi")<span class="skip"> $tlang.getString("allPurpose")</span></a> | <a id="allPurpose_delete" class="extraNodeLink" href="javascript:void(0)">$tlang.getString("delet")<span class="skip"> $tlang.getString("allPurpose")</span></a>
					</div>
					<input type="hidden" name="value_allPurpose" #if($!allPurpose) value="true" #else value="false" #end />
					<input id = "allPurpose_to_delete" name = "allPurpose_to_delete" type= "hidden" value = "false" />
				</td>
			</tr>
		</table>
	</div>

		<a name="extraNodesBoxTop"></a>
		<input type="hidden" name = "attachments_for" id="attachments_for" value="$!attachments_for" />
		<fieldset class="extraNode" id="modelanswer-node" style="display:none">## the panel for model answer
			<legend>$tlang.getString("modelAnswer")</legend>
			<div class="form-group row">
				<label for="modelanswer_text" class="col-lg-2 form-control-label">
					$tlang.getString("modelAnswer.instruction")
				</label>
				<div class="col-lg-8">
					<div class="validationError alertMessage" id="modelanswer_text_message">
						$tlang.getString("extraNodesRequired")
					</div>
					<textarea name="modelanswer_text" id="modelanswer_text" cols="60" rows="10" wrap="virtual">$validator.escapeHtmlTextarea($!modelanswer_text)</textarea>
					<textarea name="modelanswer_text_holder" id="modelanswer_text_holder" style="display:none" cols="60" rows="2" wrap="virtual">$validator.escapeHtmlTextarea($!modelanswer_text)</textarea>
				</div>
				###chef_setupformattedtextareaparams("modeltext" "200" "365" "small")
			</div>
			## attachments
			<label for="modelAnswerAttach" class="block">
					$tlang.getString("gen.att")
			</label>
			#set ($size = 0)
			#set ($props = false)
			#foreach ($attachment in $modelanswer_attachments)
				#set ($props = $attachment.Properties)
				#if ($!props)
					#set ($size = $size + 1)
				#end
			#end
			#if ($size == 0)
				<p>
                                    #if ($value_SubmissionType == 5)
                                        $tlang.getString("gen.noatt.single")
                                    #else
                                        $tlang.getString("gen.noatt")
                                    #end
                                </p>
			#else
				<ul class="attachList indnt1">
					#foreach ($attachment in $modelanswer_attachments)
						#set ($props = false)
						#set ($props = $attachment.Properties)
						#if ($!props)
							<li>
								#if ($props.getBooleanProperty($props.NamePropIsCollection))
									<img src = "#imageLink($contentTypeImageService.getContentTypeImage("folder"))" border="0" alt="$tlang.getString("gen.folatt")" />
								#else
									<img src = "#imageLink($contentTypeImageService.getContentTypeImage($props.getProperty($props.NamePropContentType)))" border="0" alt="$tlang.getString("gen.filatt")" />
								#end
								<a href="$attachment.Url" target="_blank">$formattedText.escapeHtml($props.getPropertyFormatted($props.NamePropDisplayName))</a>
								#propertyDetails($props)
							</li>
						#end
					#end
				</ul>
			#end
			<div class="act">
				<input type="button" name="modelAnswerAttach" value="$tlang.getString('gen.addatt')" onclick="document.getElementById('option').value='modelAnswerAttach';document.newAssignmentForm.submit();return false;"/>
			</div>

			<div class="form-group row form-required">

				<label for="modelanswer_to" class="col-lg-2 form-control-label">
					$tlang.getString("modelAnswer.show_to_student.prompt")
				</label>
				## show to student time option
				<div class="col-lg-8">
					<select id="modelanswer_to" name="modelanswer_showto" title="$tlang.getString("modelAnswer.show_to_student.tooltip")">
						#foreach ($k in ["0", "1", "2", "3", "4"])
							#set($string = "modelAnswer.show_to_student.")
							#set($string = $string.concat($k))
							<option value="$k" #if($k.equals($!modelanswer_showto))selected="selected" #set( $modelanswer_to_val = $k) #end> $tlang.getString($string) </option>
						#end
					</select>
					<span class="validationError alertMessageInline" id="modelanswer_to_message">
						$tlang.getString("extraNodesRequired")
					</span>

					<input type="text" id="modelanswer_to_holder"  style="display:none"  value="$modelanswer_to_val" />
				</div>
			</div>
			<p class="act">
				<input class="extraNodeInput" type="button" id="modelanswer_save" value="$tlang.getString('gen.sav')" class="active" />
				<input class="extraNodeInput" type="button" id="modelanswer_cancel" value="$tlang.getString('gen.can')" />
			</p>
		</fieldset>
		#*the panel for grading guideline
			<fieldset class="extraNode" id="gradingguidelines-node" style="display:none">
				<legend>Grading guidelines</legend>
					<div class="validationError alertMessage" id="gradingguidelines-message">
					</div>
				<div class="longtext" style="margin:.2em">
					<span class="reqStar">*</span>
					<label for="ggtext" class="block">
						Provide grading rationale. You can choose to whom and when this will display.
					</label>
						<textarea name="ggtext" id="ggtext" cols="60" rows="10" wrap="virtual"></textarea>
						###chef_setupformattedtextareaparams("ggtext" "200" "365" "small")
				</div>
				<div class="act">
						<input type="button" name="attach" value="$tlang.getString('gen.addatt')" onclick="document.getElementById('option').value='attach';document.newAssignmentForm.submit();return false;"/>
					</div>
				<p class="longtext"  style="margin:.2em">
					<span class="reqStar">*</span>
					<label for="ggwho" class="block">
						Show
					</label>
					<select id="ggwho">
						<option value="ggwhodefault"> --select one-- </option>
						<option value="ggwho1">Only to instructors</option>
						<option value="ggwho2">also to students (after grading)</option>
						<option value="ggwho3">also to students (after accept until date)</option>
					</select>
				</p>
				<p class="act">
					<input class="extraNodeInput"  type="button" value="Save" class="active"/><input class="extraNodeInput"  type="button" value="Cancel" />
				</p>
			</fieldset>
		*#
		<fieldset class="extraNode" id="note-node" style="display:none">## the panel for private note
			<legend>$tlang.getString("note")</legend>
			<div class="row form-group form-required " >
				<label for="note_text" class="col-lg-2 form-control-label">
					$tlang.getString("note.instruction")
				</label>
				<div class="col-lg-8">
					<div class="validationError alertMessage" id="note_text_message">
						$tlang.getString("extraNodesRequired")
					</div>
					#if ($!note && $!allowEditAssignmentNoteItem || !$!note)
						<textarea name="note_text" id="note_text" cols="60" rows="10" wrap="virtual">$validator.escapeHtmlTextarea($!note_text)</textarea>
						<textarea name="note_text_holder" id="note_text_holder"  style="display:none"  cols="60" rows="2" wrap="virtual">$validator.escapeHtmlTextarea($!note_text)</textarea>
					#else
						#if ($!allowReadAssignmentNoteItem)
					 		<div class="notes">$formattedText.escapeHtml($!note_text)</div>
				 		#end
					#end
					###chef_setupformattedtextareaparams("assigntext" "200" "365" "small")
				</div>
			</div>
			<div class="row form-group form-required">
				<label for="note_to" class="col-lg-2 form-control-label">
					$tlang.getString("note.to.prompt")
				</label>
				<div class="col-lg-8">
					#if ($!note && $!allowEditAssignmentNoteItem || !$!note)
						<select id="note_to" name="note_to" title="$tlang.getString("note.to.tooltip")">
							#foreach ($k in ["0", "1", "2", "3"])
								#set($string = "note.to.")
								#set($string = $string.concat($k))
								<option value="$k" #if($k.equals($!note_to)) selected="selected" #set ($note_to_val=$k) #end> $tlang.getString($string) </option>
							#end
						</select>
					#else
						#if ($!allowReadAssignmentNoteItem)
							#foreach ($k in ["0", "1", "2", "3"])
								#set($string = "note.to.")
								#set($string = $string.concat($k))
								#if($k.equals($!note_to))
									$tlang.getString($string)
								#end
							#end
						#end
					#end
					<span class="validationError alertMessageInline" id="note_to_message">
						$tlang.getString("extraNodesRequired")
					</span>
					<input type="text" id="note_to_holder"  style="display:none"  value="$note_to_val" />
				</div>
			</div>
			#if ($!note && $!allowEditAssignmentNoteItem || !$!note)
				<p class="act">
					## can only edit if there is no note item, or if there is a note item and the current user can edit it.
					<input class="extraNodeInput" type="button" id="note_save" value="$tlang.getString('gen.sav')" class="active" />
					<input class="extraNodeInput" type="button" id="note_cancel" value="$tlang.getString('gen.can')" />
				</p>
			#end
		</fieldset>
		<fieldset class="extraNode" id="allPurpose-node" style="display:none">## the panel for allPurpose type of object
			<legend>$tlang.getString('allPurpose')</legend>
			<div class="form-group row">
				<label  for="allPurpose_title" class="form-control-label col-lg-2">
					$formattedText.escapeHtml($tlang.getString("gen.title"))
				</label>
				<div class="col-lg-8">
					<input id="allPurpose_title" name="allPurposeTitle" type="text" size="20" maxlength="30" value="$!value_allPurposeTitle" class="form-control"/>
					<input id="allPurpose_title_holder"  style="display:none"  name="allPurposeTitle" type="text" size="2" maxlength="30" value="$!value_allPurposeTitle" />
					<span class="validationError alertMessageInline" id="allPurpose_title_message">
						$tlang.getString("extraNodesRequired")
					</span>
				</div>
			</div>

			<div class="form-group row">
				<label for="allPurpose_text" class="form-control-label col-lg-2">
					$tlang.getString("allPurpose.instruction")
				</label>
				<div class="col-lg-8">
					<div class="validationError alertMessage" id="allPurpose_text_message">
						$tlang.getString("extraNodesRequired")
					</div>
					<textarea name="allPurposeText" id="allPurpose_text" cols="60" rows="10" wrap="virtual">$validator.escapeHtmlTextarea($!value_allPurposeText)</textarea>
					<textarea name="allPurposeTextHolder"  id="allPurpose_text_holder"  style="display:none"  cols="60" rows="2" wrap="virtual">$validator.escapeHtmlTextarea($!value_allPurposeText)</textarea>
				</div>
			</div>
			## attachments for allpurpose item
			<label for="allPurposeAttach" class="form-control-label block">
					$tlang.getString("gen.att")
			</label>
			#set ($size = 0)
			#set ($props = false)
			#foreach ($attachment in $allPurpose_attachments)
				#set ($props = $attachment.Properties)
				#if ($!props)
					#set ($size = $size + 1)
				#end
			#end
			#if ($size == 0)
				<p>
                                    #if ($value_SubmissionType == 5)
                                        $tlang.getString("gen.noatt.single")
                                    #else
                                        $tlang.getString("gen.noatt")
                                    #end
                                </p>
			#else
				<ul class="attachList indnt1">
					#foreach ($attachment in $allPurpose_attachments)
						#set ($props = false)
						#set ($props = $attachment.Properties)
						#if ($!props)
							<li>
								#if ($props.getBooleanProperty($props.NamePropIsCollection))
									<img src = "#imageLink($contentTypeImageService.getContentTypeImage("folder"))" border="0" alt="$tlang.getString("gen.folatt")" />
								#else
									<img src = "#imageLink($contentTypeImageService.getContentTypeImage($props.getProperty($props.NamePropContentType)))" border="0" alt="$tlang.getString("gen.filatt")" />
								#end
								<a href="$attachment.Url" target="_blank">$formattedText.escapeHtml($props.getPropertyFormatted($props.NamePropDisplayName))</a>
								#propertyDetails($props)
							</li>
						#end
					#end
				</ul>
			#end

			<div class="act">
				<input type="button" name="allPurposeAttach" id="allPurposeAttach" value="$tlang.getString('gen.addatt')" onclick="document.getElementById('option').value='allPurposeAttach';document.newAssignmentForm.submit();return false;"/>
			</div>
			<div class="validationError alertMessage" id="allPurpose_release_after_retract_message">
				$tlang.getString("allPurpose.alert.release.afer.retract")
			</div>
			## Show This Item Checkbox
			<div class="form-group row">

				<div class="col-sm-3">
					<label for="allPurposeHide1" class="form-control-label">
						<input name="allPurposeHide" id="allPurposeHide1" value="false" #if(!$!value_allPurposeHide)checked="checked"#end type="radio" />
						$tlang.getString("allPurpose.show")
					</label>
				</div>

				<div class="col-sm-9">
					<div class="form-group d-flex align-items-center justify-content-evenly">
						<label for="allPurposeShowFrom" class="col-sm-2 form-control-label">
							<input name="allPurposeShowFrom" id="allPurposeShowFrom" value="true" type="checkbox" #if ($value_allPurposeShowFrom) checked="checked" #end />
							$tlang.getString("allPurpose.show.from")
						</label>
						<div class="col-sm-10">
							<sakai-date-picker
								hidden-prefix="all_purpose_release_"
								iso-date="$value_allPurposeReleaseYear$H$value_allPurposeReleaseMonth$H$value_allPurposeReleaseDay$T$value_allPurposeReleaseHour:$value_allPurposeReleaseMin"
								add-hidden-fields>
							</sakai-date-picker>
						</div>
					</div>
					<div class="form-group d-flex align-items-center justify-content-evenly">
						<label for="allPurposeShowTo" class="col-sm-2 form-control-label">
							<input name="allPurposeShowTo" id="allPurposeShowTo" value="true" type="checkbox" #if ($!value_allPurposeShowTo) checked="checked" #end />
							$tlang.getString("allPurpose.show.util")
						</label>
						<div class="col-sm-10">
							<sakai-date-picker
								hidden-prefix="all_purpose_retract_"
								iso-date="$value_allPurposeRetractYear$H$value_allPurposeRetractMonth$H$value_allPurposeRetractDay$T$value_allPurposeRetractHour:$value_allPurposeRetractMin"
								add-hidden-fields>
							</sakai-date-picker>
						</div>
					</div>
				</div>
			</div>
			## Hide This Item Checkbox
			<label for="allPurposeHide2" class="form-control-label">
				<input name="allPurposeHide" id="allPurposeHide2" value="true" #if($!value_allPurposeHide)checked="checked"#end type="radio" />
				$tlang.getString("allPurpose.show.hide")
			</label>
			<h4><span class="reqStar">*</span>$tlang.getString("allPurpose.show.to")</h4>
			<div class="validationError alertMessage" id="allPurpose_userselect">
				$tlang.getString("extraNodesRequired")
			</div>
			<div class="table">
			<table class="table table-striped table-bordered table-hover" id="allPurposeGroupLists">
				<tbody>
					#set ($roleCount=0)
					#foreach ($role in $!roleUsers.keySet())
						#set ($allSelected=true)
						#set ($roleCount=$roleCount + 1)
						#set($expandString=$tlang.getString("allPurpose.show.expand").concat(" ").concat($role).concat(" ").concat($tlang.getString("allPurpose.show.list")))
						#set($collapseString=$tlang.getString("allPurpose.show.collapse").concat(" ").concat($role).concat(" ").concat($tlang.getString("allPurpose.show.list")))
						#set($expandId = "expand_")
						#set($expandId = $expandId.concat($role))
						#set($collapseId="collapse_")
						#set($collapseId=$collapseId.concat($role))
						#set($roleDivString = $role.concat("Div"))
						#set($showInputString = "allPurpose_")
						#set($showInputString = $showInputString.concat($role))
						<tr>
							<td class="groupCell">
								<a href="javascript:void(0)" id="collapse_$roleCount" class="toggleRoleLink" style="display:none;" title="$collapseString">
									<img src="/library/image/sakai/collapse.gif" alt="$collapseString" /><span class="members"><i class="si si-sakai-membership"></i></span>
								</a>
								<a href="javascript:void(0)" id="expand_$roleCount" class="toggleRoleLink" style="display:inline" title="$expandString">
									<img src="/library/image/sakai/expand.gif"  alt="$expandString"/><span class="members"><i class="si si-sakai-membership"></i></span>
								</a>
								<input id="$showInputString" name="showInputString_$roleCount" #if ($!value_allPurposeAccessList.contains($role)) checked="checked" #end type="checkbox" name="allPurpose_$role" class="selectAllMembers"/>
								<label for="showInputString_$roleCount" class="form-control-label">
									$role
								</label>
								(<span class="highlight countDisplay"></span> <span class="highlight">$tlang.getString("allPurpose.user.selection.count")</span>)
								<ul id="roleDiv_$roleCount"  style="display:none;" class="attachList userList">
									#set($userCount=0)
									#foreach($user in $!roleUsers.get($role))
										#set($showInputString = "allPurpose_")
										#set($showInputString = $showInputString.concat($user.getId()))
										<li>
											<label for="$showInputString" class="form-control-label" style="white-space:nowrap;padding:2px;width:90%;display:block" #if ($!value_allPurposeAccessList.contains($user.getId())) class="selectedItem" #else #set ($allSelected=false) #end>
												<input id="$showInputString" name="$showInputString" #if ($!value_allPurposeAccessList.contains($user.getId())) class="selectedItem" checked="checked" #set($userCount=$userCount + 1) #end type="checkbox" value="$user.Id"/>
												$formattedText.escapeHtml($user.getDisplayName())
											</label>
										</li>
									#end
									<li class="countHolder" class="skip" style="display:none">$userCount</li>
								</ul>
								#if($!allSelected)
									<script>
										$('#allPurposeGroupLists tr:last').find('.selectAllMembers').prop('checked', true);
									</script>
								#end
							</td>
						</tr>
					#end
				</tbody>
			</table>
			</div>
			<p class="act" style="margin:0;padding:0">
				<input class="extraNodeInput" type="button" id="allPurpose_save" value="$tlang.getString("allPurpose_save")" class="active"/>
				<input class="extraNodeInput" type="button" id ="allPurpose_cancel" value="$tlang.getString("allPurpose_cancel")" />
			</p>
		</fieldset>
</div> <!-- id="additionalInformation" -->
		<div class="row col-sm-12">
			#buttonBar()
		</div>
		<input type="hidden" name="sakai_csrf_token" value="$sakai_csrf_token" />
	</div>

	</form>
</div>
</div>
</div>
</div>
<!-- end: chef_assignments_instructor_new_edit_assignment.vm  -->
