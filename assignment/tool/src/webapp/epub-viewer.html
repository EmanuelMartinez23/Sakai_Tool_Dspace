<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Visor EPUB</title>
  <style>
    html, body { height: 100%; margin: 0; }
    body { display: flex; flex-direction: column; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", sans-serif; }
    .toolbar { display: flex; align-items: center; gap: .5rem; padding: .5rem .75rem; border-bottom: 1px solid #e5e5e5; background: #fafafa; }
    .toolbar .title { font-weight: 600; margin-right: auto; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .toolbar button { padding: .35rem .65rem; font-size: .9rem; cursor: pointer; }
    .toolbar select { max-width: 50vw; }
    .viewer { position: relative; flex: 1; min-height: 0; background: #f3f3f3; }
    #viewer { position: absolute; inset: 0; margin: auto; width: min(1000px, 100%); height: 100%; box-shadow: 0 0 0 1px #ddd inset; background: #fff; }
    .footer { display: flex; align-items: center; gap: .75rem; padding: .4rem .75rem; border-top: 1px solid #e5e5e5; background: #fafafa; font-size: .85rem; }
    .spacer { flex: 1; }
    .hint { color: #6b7280; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/epubjs@0.3/dist/epub.min.js"></script>
</head>
<body>
  <div class="toolbar">
    <div class="title" id="bookTitle">EPUB</div>
    <button id="prevBtn" title="Anterior">⟨</button>
    <button id="nextBtn" title="Siguiente">⟩</button>
    <select id="tocSelect" title="Tabla de contenidos">
      <option value="">Índice…</option>
    </select>
  </div>
  <div class="viewer">
    <div id="viewer" aria-label="EPUB viewer" role="region"></div>
  </div>
  <div class="footer">
    <span id="locInfo" class="hint">Página 1</span>
    <span class="spacer"></span>
    <a id="openSrc" href="#" target="_blank" rel="noopener" title="Abrir archivo original">Abrir archivo</a>
  </div>
  <script>
    (function(){
      function getSrc(){
        try {
          var u = new URL(window.location.href);
          var qs = u.searchParams.get('src');
          if (qs) return qs;
        } catch(e){}
        // Fallback a hash #src=...
        if (location.hash && location.hash.indexOf('src=') >= 0) {
          try { return decodeURIComponent(location.hash.split('src=')[1]); } catch(e) {}
        }
        return null;
      }

      var src = getSrc();
      var openSrc = document.getElementById('openSrc');
      if (src) openSrc.href = src; else openSrc.removeAttribute('href');

      if (!window.ePub) {
        document.getElementById('viewer').innerHTML = '<div style="padding:1rem">No se pudo cargar EPUB.js</div>';
        return;
      }

      if (!src) {
        document.getElementById('viewer').innerHTML = '<div style="padding:1rem">Falta el parámetro <code>src</code> con la URL del EPUB.</div>';
        return;
      }

      // Inicializar libro
      var book = ePub(src);
      var rendition = book.renderTo('viewer', { width: '100%', height: '100%' });
      rendition.display();

      // Título
      book.loaded.metadata.then(function(meta){
        if (meta && meta.title) {
          document.getElementById('bookTitle').textContent = meta.title;
          document.title = meta.title + ' · Visor EPUB';
        }
      });

      // Navegación prev/next
      document.getElementById('prevBtn').addEventListener('click', function(){ rendition.prev(); });
      document.getElementById('nextBtn').addEventListener('click', function(){ rendition.next(); });
      document.addEventListener('keydown', function(e){
        if (e.key === 'ArrowLeft') rendition.prev();
        if (e.key === 'ArrowRight') rendition.next();
      });

      // Tabla de contenidos
      var tocSelect = document.getElementById('tocSelect');
      book.loaded.navigation.then(function(nav){
        if (!nav || !nav.toc) return;
        nav.toc.forEach(function(ch){
          var opt = document.createElement('option');
          opt.value = ch.href; opt.textContent = ch.label || ch.href;
          tocSelect.appendChild(opt);
        });
        tocSelect.addEventListener('change', function(){
          if (this.value) rendition.display(this.value);
        });
      });

      // Información de ubicación
      book.ready.then(function(){
        return book.locations.generate(600);
      }).then(function(){
        rendition.on('relocated', function(loc){
          try {
            var current = book.locations.percentageFromCfi(loc.start.cfi);
            if (typeof current === 'number') {
              var pct = Math.max(0, Math.min(1, current));
              var page = Math.max(1, Math.round(pct * 100));
              document.getElementById('locInfo').textContent = 'Página ' + page + ' · ' + Math.round(pct*100) + '%';
            }
          } catch(e){}
        });
      });

      // Manejo básico de CORS: si el navegador bloquea la carga del EPUB por CORS, mostrar mensaje útil
      book.opened.catch(function(err){
        console.error(err);
        var msg = 'No se pudo abrir el EPUB. Si el archivo está en otro dominio, es posible que el navegador bloquee por CORS. ' +
                  'Contacta al administrador para habilitar CORS en la URL del EPUB o utilizar un proxy local.';
        document.getElementById('viewer').innerHTML = '<div style="padding:1rem;color:#b91c1c">' + msg + '</div>';
      });
    })();
  </script>
</body>
</html>
